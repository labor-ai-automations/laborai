<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Projetos - LaborAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --background-dark: #111827; --surface-dark: #1f2937; --border-dark: #374151;
            --primary-accent: #3b82f6; --primary-accent-hover: #60a5fa; --text-primary: #f9fafb;
            --text-secondary: #9ca3af; --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-dark); color: var(--text-primary); margin: 0; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Login */
        #login-section { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-card { background: var(--surface-dark); padding: 40px; border-radius: 12px; border: 1px solid var(--border-dark); width: 100%; max-width: 400px; text-align: center; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--border-dark); border-radius: 6px; box-sizing: border-box; background-color: #374151; color: var(--text-primary); font-size: 16px; font-family: 'Inter', sans-serif; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; background-color: var(--primary-accent); color: white; font-weight: 500; font-size: 16px; cursor: pointer; transition: background-color 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        button:hover { background-color: var(--primary-accent-hover); }
        button:disabled { background-color: #4b5563; cursor: not-allowed; }
        
        /* Button Variants */
        button.secondary { background: transparent; border: 1px solid var(--border-dark); color: var(--text-primary); }
        button.secondary:hover { background: var(--border-dark); }
        button.danger { background-color: rgba(239, 68, 68, 0.2); color: var(--error-color); border: 1px solid var(--error-color); }
        button.danger:hover { background-color: rgba(239, 68, 68, 0.3); }
        button.primary { /* Padr√£o, mas explicito se necess√°rio via JS */ } 
        button.icon-btn { width: auto; padding: 6px 12px; font-size: 14px; }
        
        /* Header */
        #app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border-dark); margin-bottom: 24px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .client-logo-header-img { height: 32px; object-fit: contain; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-right: 20px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .project-card, .client-card { background: var(--surface-dark); padding: 20px; border-radius: 8px; border: 1px solid var(--border-dark); cursor: pointer; transition: transform 0.2s, border-color 0.2s; position: relative; }
        .project-card:hover, .client-card:hover { transform: translateY(-3px); border-color: var(--primary-accent); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .client-logo-thumb { height: 40px; max-width: 100px; object-fit: contain; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 4px; }
        
        /* Timeline/Details - Accordion Styles */
        .phase-header { border: 2px solid var(--border-dark); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--surface-dark); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .phase-header.active { border-color: var(--primary-accent); animation: pulse-border 3s infinite; }
        .phase-header::after { content: '‚ñº'; margin-left: 10px; transition: transform 0.3s; font-size: 0.8em; }
        .phase-header.expanded::after { transform: rotate(180deg); }
        
        .phase-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .phase-header.expanded + .phase-content { max-height: 2000px; transition: max-height 0.5s ease-in; }

        /* Phase Actions Hover Effect */
        .phase-header .phase-actions { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .phase-header:hover .phase-actions { opacity: 1; }

        .update { margin-left: 20px; margin-bottom: 12px; padding: 15px; background: var(--background-dark); border-left: 3px solid var(--border-dark); border-radius: 0 8px 8px 0; position: relative; }
        .update-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; opacity: 0.7; }
        .update-actions:hover { opacity: 1; }
        .update img {
            max-height: 300px; /* Limita a altura da imagem na timeline */
            width: auto;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .update img:hover {
            opacity: 0.8;
        }
        
        /* Admin Sections */
        .admin-section-card { border: 1px solid var(--border-dark); border-radius: 8px; padding: 20px; margin-top: 20px; background: var(--surface-dark); }
        .admin-toolbar { display: flex; gap: 8px; margin-top: 10px; }
        
        /* Toast */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.75rem; max-width: 420px; }
        .toast { padding: 1rem 1.25rem; border-radius: 8px; background-color: var(--surface-dark); border-left: 4px solid; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
        .toast.success { border-color: var(--success-color); } .toast.error { border-color: var(--error-color); } .toast.info { border-color: var(--primary-accent); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* Modals */
        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface-dark); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; border: 1px solid var(--border-dark); max-height: 90vh; overflow-y: auto; }
        
        /* Contacts List in Modal */
        .contact-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-dark); }
        .contact-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- TELA DE LOGIN -->
    <div id="login-section">
        <div class="login-card">
            <h2>Portal LaborAI</h2>
            <p>Acesse para gerenciar seus projetos.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" placeholder="Sua senha" required>
                <button type="submit">Entrar</button>
            </form>
        </div>
    </div>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div id="app-container" class="container hidden">
        <header id="app-header">
            <div class="header-left">
                <!-- Logo do Cliente (Carregada Dinamicamente) -->
                <img id="header-client-logo" class="client-logo-header-img hidden" alt="Logo">
                <div>
                    <strong style="font-size: 1.2rem;">LaborAI</strong>
                    <span id="header-client-name" style="color: var(--text-secondary); margin-left: 8px;"></span>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                
                <!-- Toggle "Ver como Cliente" (Apenas Admin) -->
                <div id="admin-simulation-toggle" class="toggle-container hidden">
                    <span style="font-size: 0.9em; color: var(--text-secondary);">Ver como Cliente</span>
                    <label class="switch">
                        <input type="checkbox" id="client-view-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <span id="user-email" style="font-size: 0.9em; margin-right: 16px; color: var(--text-secondary);"></span>
                
                <!-- Bot√£o Painel Admin (Apenas Admin) -->
                <button id="admin-panel-button" class="hidden secondary" style="width: auto; padding: 6px 12px; margin-right: 10px;">
                    ‚öôÔ∏è Painel & Cria√ß√£o
                </button>
                
                <button id="logout-button" class="secondary" style="width: auto; padding: 6px 12px;">Sair</button>
            </div>
        </header>

        <main id="main-content">
            <!-- VIEW 1: Lista de Clientes (Home do Admin) -->
            <div id="client-list-view" class="hidden">
                <h3>Meus Clientes</h3>
                <div id="clients-list" class="card-grid"></div>
            </div>

            <!-- VIEW 2: Lista de Projetos (Home do Cliente / Navega√ß√£o Admin) -->
            <div id="project-list-view" class="hidden">
                <button id="back-to-clients-button" class="secondary hidden" style="margin-bottom: 20px;">&larr; Voltar para Clientes</button>
                <!-- Adicionar logo ap√≥s o bot√£o de voltar -->
                <h2 style="font-weight: 500; border-bottom: 1px solid var(--border-dark); padding-bottom: 16px; margin-bottom: 24px;">Projetos</h2>
                <div id="project-list-content" class="card-grid"></div>
            </div>

            <!-- VIEW 3: Detalhes do Projeto (Timeline) -->
            <div id="project-detail-view" class="hidden">
                <button id="back-to-projects-button" class="secondary" style="margin-bottom: 20px;">&larr; Voltar para Projetos</button>
                
                <!-- Cabe√ßalho do Projeto Refatorado -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 id="project-detail-name" style="margin: 0;">Nome do Projeto</h2>
                    <button id="toggle-add-update-form" class="primary icon-btn hidden">[+] Nova Atualiza√ß√£o</button>
                </div>

                <!-- Adicionar logo ap√≥s o <div> do t√≠tulo e bot√£o "Nova Atualiza√ß√£o" -->
                <div id="project-description-container" class="admin-section-card" style="margin-bottom: 24px; padding: 20px;">
                    <h3 style="margin-top: 0; margin-bottom: 10px;">Sobre o Projeto</h3>
                    <p id="project-detail-description" style="color: var(--text-secondary); margin: 0; white-space: pre-wrap;"></p>
                </div>

                <!-- ESTRUTURA NOVA E MELHORADA -->
                <div id="progress-view-container" class="admin-section-card" style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">üìä Progresso</h3>
                        <span id="progress-percentage-display" style="font-weight: bold; font-size: 1.1rem;">0%</span>
                    </div>
                    <!-- Barra de progresso visual para todos -->
                    <div style="height: 8px; background-color: var(--border-dark); border-radius: 4px; overflow: hidden;">
                        <div id="progress-bar-fill" style="width: 0%; height: 100%; background-color: var(--primary-accent); transition: width 0.3s;"></div>
                    </div>
                    <!-- Controles exclusivos para o admin -->
                    <div id="admin-progress-controls" class="hidden" style="margin-top: 15px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="range" min="0" max="100" value="0" id="progress-slider" style="flex: 1;">
                            <button id="save-progress-button" style="width: auto;">Salvar</button>
                        </div>
                    </div>
                </div>

                <!-- Conte√∫do da Timeline -->
                <div id="project-detail-content" style="margin-top: 24px;"></div>

                <!-- Template do Formul√°rio (Oculto, clonado para o modal) -->
                <div id="add-update-form-container" class="hidden">
                    <form id="add-update-form">
                        <select id="update-phase-select" required></select>
                        <input type="text" id="update-title" placeholder="T√≠tulo da atualiza√ß√£o" required>
                        <textarea id="update-description" rows="3" placeholder="Descri√ß√£o detalhada... (Obrigat√≥rio)"></textarea>
                        <input type="url" id="update-link" placeholder="Anexar Link (Opcional, ex: https://...)">
                        <label for="update-file" style="font-size: 0.9em; color: var(--text-secondary);">Anexar Arquivo (Opcional):</label>
                        <input type="file" id="update-file">
                        <button type="submit" id="add-update-button" style="margin-top:15px;">Publicar Atualiza√ß√£o</button>
                    </form>
                </div>
            </div>

            <!-- VIEW 4: Painel Administrativo (Formul√°rios de Cria√ß√£o) -->
            <div id="admin-forms-view" class="hidden">
                <button id="back-from-admin-panel" class="secondary" style="margin-bottom: 20px;">&larr; Voltar</button>
                <h2>Painel de Gest√£o & Cria√ß√£o</h2>
                
                <div class="card-grid">
                    <!-- Upload de Logo -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üñºÔ∏è Logo do Cliente</h3>
                        <form id="upload-logo-form">
                            <label>Cliente:</label>
                            <select id="logo-client-select" required></select>
                            <label>Arquivo (PNG/JPG/SVG):</label>
                            <input type="file" id="logo-file-input" accept="image/png, image/jpeg, image/svg+xml" required>
                            <button type="submit" id="upload-logo-button">Salvar Logo</button>
                        </form>
                    </div>

                    <!-- Criar Cliente -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üè¢ Novo Cliente</h3>
                        <form id="create-client-form">
                            <label>Nome da Empresa:</label>
                            <input type="text" id="new-client-name" placeholder="Ex: Molas Fama" required>
                            <button type="submit" id="create-client-button">Criar Cliente</button>
                        </form>
                    </div>

                    <!-- Criar Usu√°rio -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üë§ Novo Usu√°rio</h3>
                        <form id="create-user-form">
                            <label>Associar ao Cliente:</label>
                            <select id="user-client-select" required></select>
                            <label>E-mail:</label>
                            <input type="email" id="new-user-email" required>
                            <label>Senha Provis√≥ria:</label>
                            <input type="password" id="new-user-password" required>
                            <button type="submit" id="create-user-button">Criar Usu√°rio</button>
                        </form>
                    </div>
                </div>

                <!-- Criar Projeto -->
                <div class="admin-section-card">
                    <h3>üöÄ Novo Projeto</h3>
                    <form id="create-project-form">
                        <label>Cliente:</label>
                        <select id="project-client-select" required></select>
                        <label>Nome do Projeto:</label>
                        <input type="text" id="new-project-name" required>
                        <label>Descri√ß√£o:</label>
                        <textarea id="new-project-description" rows="2"></textarea>
                        <label>Template de Fases:</label>
                        <select id="phase-template-select" required></select>
                        <textarea id="new-project-phases" rows="4" class="hidden" placeholder="Fase 1..."></textarea>
                        <button type="submit" id="create-project-button">Criar Projeto</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: Nova Vers√£o -->
    <div id="new-version-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Iniciar Nova Vers√£o</h3>
            <form id="new-version-form">
                <input type="text" id="new-version-number" placeholder="Ex: V2.0" required>
                <textarea id="new-version-summary" rows="3" placeholder="Resumo das mudan√ßas..." required></textarea>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="secondary" onclick="document.getElementById('new-version-modal').classList.add('hidden')">Cancelar</button>
                    <button type="submit">Criar Vers√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Gerenciar Contatos -->
    <div id="contacts-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Gerenciar Contatos</h3>
            <p id="contacts-modal-client-name" style="color: var(--text-secondary); margin-bottom: 15px;"></p>
            
            <!-- Lista -->
            <div id="contacts-list" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-dark); border-radius: 6px;">
                <!-- Itens inseridos via JS -->
            </div>

            <!-- Adicionar Novo -->
            <h4 style="border-top: 1px solid var(--border-dark); padding-top: 15px;">Adicionar Novo</h4>
            <form id="add-contact-form">
                <input type="text" id="contact-name" placeholder="Nome" required style="margin-bottom: 8px;">
                <input type="text" id="contact-role" placeholder="Cargo" style="margin-bottom: 8px;">
                <input type="text" id="contact-whatsapp" placeholder="WhatsApp (55119...)" required style="margin-bottom: 8px;">
                <button type="submit" id="add-contact-btn">Adicionar Contato</button>
            </form>
            <button class="secondary" onclick="document.getElementById('contacts-modal').classList.add('hidden')" style="margin-top: 15px; width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA A√á√ïES -->
    <div id="generic-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="modal-title">T√≠tulo Padr√£o</h3>
            <div id="modal-body" style="margin: 20px 0;">
                <!-- Conte√∫do ser√° injetado aqui via JS -->
            </div>
            <div id="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <!-- Bot√µes ser√£o injetados aqui via JS -->
            </div>
        </div>
    </div>

    <!-- LIGHTBOX PARA IMAGENS -->
    <div id="image-lightbox" class="modal hidden">
        <div class="modal-content" style="max-width: 90%; max-height: 90%; display: flex; gap: 20px; padding: 20px;">
            <div style="flex: 2; display: flex; justify-content: center; align-items: center; position: relative;">
                <img id="lightbox-img" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                <a id="lightbox-download-link" href="#" download class="icon-btn" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5);">üì• Download</a>
            </div>
            <div id="lightbox-info-panel" style="flex: 1; border-left: 1px solid var(--border-dark); padding-left: 20px; overflow-y: auto;">
                <h3 id="lightbox-update-title" style="margin-top: 0;"></h3>
                <small id="lightbox-update-date" style="color: var(--text-secondary); display: block; margin-bottom: 15px;"></small>
                <p id="lightbox-update-description"></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURA√á√ÉO ---
            const SUPABASE_URL = 'https://vzmhnponxmrvoqctmpty.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6bWhucG9ueG1ydm9xY3RtcHR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3Mzg5MjYsImV4cCI6MjA3MDMxNDkyNn0.sSfMCpPKwFp2lVLuWnFN066OT0lluMb-sd-kWb1PePg';
            
            // Webhooks do N8N
            const N8N_BASE = 'https://n8n-n8n.znxk1t.easypanel.host/webhook';
            const HOOKS = {
                // Uploads e Cria√ß√£o
                ATUALIZAR_LOGO: `${N8N_BASE}/atualizar-logo-cliente`,
                CRIAR_CLIENTE: `${N8N_BASE}/criar-novo-cliente`,
                CRIAR_USUARIO: `${N8N_BASE}/criar-novo-usuario`,
                CRIAR_PROJETO: `${N8N_BASE}/criar-novo-projeto`,
                SALVAR_ATUALIZACAO: `${N8N_BASE}/salvar-atualizacao`,
                
                // Gest√£o de Projeto
                ATUALIZAR_PROGRESSO: `${N8N_BASE}/atualizar-progresso-projeto`,
                ATUALIZAR_STATUS_FASE: `${N8N_BASE}/atualizar-status-fase`,
                CRIAR_NOVA_VERSAO: `${N8N_BASE}/criar-nova-versao`,
                NOTIFICAR_WHATSAPP: `${N8N_BASE}/notificar-whatsapp`,
                
                // CRUD e Gest√£o
                CRIAR_CONTATO: `${N8N_BASE}/criar-contato-cliente`,
                EXCLUIR_CONTATO: `${N8N_BASE}/excluir-contato-cliente`,
                EDITAR_PROJETO: `${N8N_BASE}/editar-projeto`, 
                EXCLUIR_PROJETO: `${N8N_BASE}/excluir-projeto`, 
                EXCLUIR_ATUALIZACAO: `${N8N_BASE}/excluir-atualizacao`
            };

            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- ESTADO GLOBAL ---
            let state = {
                user: null,
                isAdmin: false,
                isSimulatingClient: false,
                clients: [],
                projects: [],
                contacts: [],
                currentClientId: null,
                currentProjectId: null,
                currentVersionId: null,
                phaseTemplates: [
                    { name: "Padr√£o (3 Fases)", phases: ["Levantamento", "Desenvolvimento", "Valida√ß√£o"] },
                    { name: "Completo (5 Fases)", phases: ["Diagn√≥stico", "Design", "Dev", "Homologa√ß√£o", "Go-Live"] },
                    { name: "Customizado", phases: [] }
                ]
            };

            // --- UTILS ---
            const Toast = {
                container: document.getElementById('toast-container'),
                show(type, msg) {
                    const el = document.createElement('div'); el.className = `toast ${type}`;
                    el.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${msg}</span>`;
                    this.container.appendChild(el);
                    setTimeout(() => el.remove(), 4000);
                },
                success(m) { this.show('success', m); }, error(m) { this.show('error', m); }, info(m) { this.show('info', m); }
            };

            // Fun√ß√£o de escape para strings em HTML
            function escapeHtml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                    .replace(/`/g, "&#96;"); // Importante para template literals
            }
            
            function getGoogleDriveDirectImage(url) {
                if (!url || typeof url !== 'string') return null;
                
                // Tenta extrair o ID do formato /file/d/ID/...
                let match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    const fileId = match[1];
                    // Constr√≥i a URL de imagem direta
                    return `https://lh3.googleusercontent.com/d/${fileId}`;
                }
                
                // Tenta extrair o ID do formato de link de compartilhamento ?id=ID
                match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    const fileId = match[1];
                    return `https://lh3.googleusercontent.com/d/${fileId}`;
                }
                
                // Se nenhum formato conhecido for encontrado, retorna nulo
                return null;
            }

            // Sistema de Modal Gen√©rico
            window.showGenericModal = function({ title, bodyHtml, buttons }) {
                const modal = document.getElementById('generic-modal');
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = bodyHtml;

                const footer = document.getElementById('modal-footer');
                footer.innerHTML = ''; // Limpa bot√µes antigos

                // Bot√£o para fechar o modal
                const closeModal = () => modal.classList.add('hidden');

                // Adiciona um bot√£o de "Cancelar" padr√£o (se houver bot√µes customizados ou se n√£o houver nenhum)
                if (buttons.length > 0 || buttons.length === 0) {
                    const cancelButton = document.createElement('button');
                    cancelButton.className = 'secondary';
                    cancelButton.innerText = 'Cancelar';
                    cancelButton.onclick = closeModal;
                    footer.appendChild(cancelButton);
                }

                // Adiciona bot√µes customizados
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.innerText = btnConfig.label;
                    if (btnConfig.classes) button.className = btnConfig.classes;
                    
                    button.onclick = async () => {
                        const originalText = button.innerText;
                        button.disabled = true;
                        button.innerText = '...';
                        try {
                            await btnConfig.onClick();
                            closeModal();
                        } catch (e) {
                            console.error(e);
                            Toast.error("Erro na a√ß√£o");
                        } finally {
                            button.disabled = false;
                            button.innerText = originalText;
                        }
                    };
                    footer.appendChild(button);
                });

                modal.classList.remove('hidden');
            };

            function openImageLightbox(update) {
                const lightbox = document.getElementById('image-lightbox');
                const img = document.getElementById('lightbox-img');
                const downloadLink = document.getElementById('lightbox-download-link');
                
                const directImageUrl = getGoogleDriveDirectImage(update.content_url);
                if (!directImageUrl) return;

                img.src = directImageUrl;
                // Para download, o webContentLink √© melhor
                downloadLink.href = update.content_url.replace(/(&?)(export=download|usp=drivesdk|view)$/, '') + '&export=download';
                
                document.getElementById('lightbox-update-title').innerText = update.title;
                document.getElementById('lightbox-update-date').innerText = new Date(update.created_at).toLocaleString('pt-BR');
                document.getElementById('lightbox-update-description').innerText = update.description || 'Sem descri√ß√£o.';
                
                lightbox.classList.remove('hidden');
            }

            const Views = {
                login: document.getElementById('login-section'),
                app: document.getElementById('app-container'),
                clientList: document.getElementById('client-list-view'),
                projectList: document.getElementById('project-list-view'),
                projectDetail: document.getElementById('project-detail-view'),
                adminForms: document.getElementById('admin-forms-view')
            };

            function showView(viewName) {
                Object.values(Views).forEach(el => { if(el && el !== Views.app) el.classList.add('hidden'); });
                if (viewName !== 'login') Views.app.classList.remove('hidden');
                if (Views[viewName]) Views[viewName].classList.remove('hidden');
            }

            // --- DATA FETCHING (LEITURA via Supabase, ESCRITA via Webhook) ---
            async function loadData() {
                try {
                    // 1. Carregar Projetos
                    let query = supabaseClient.from('laborai_projects').select(`*, laborai_clients(name, logo_url), laborai_project_versions(*, laborai_project_phases(*, laborai_phase_updates(*)))`).order('created_at', { ascending: false });
                    
                    if (!state.isAdmin) {
                        const clientId = state.user.user_metadata.clientId;
                        if (clientId) query = query.eq('client_id', clientId);
                    }
                    
                    const { data: projData, error: projError } = await query;
                    if (projError) throw projError;
                    state.projects = projData;

                    // 2. Carregar Clientes (Apenas Admin)
                    if (state.isAdmin) {
                        const { data: clientData, error: clientError } = await supabaseClient.from('laborai_clients').select('*').order('name');
                        if (clientError) throw clientError;
                        state.clients = clientData;
                    }
                } catch (e) {
                    console.error(e);
                    Toast.error('Erro ao carregar dados: ' + e.message);
                }
            }

            // --- RENDERIZA√á√ÉO ---

            // 1. HEADER
            function renderHeader() {
                document.getElementById('user-email').textContent = state.user.email;
                const adminPanelBtn = document.getElementById('admin-panel-button');
                const toggleContainer = document.getElementById('admin-simulation-toggle');
                
                if (state.isAdmin) {
                    toggleContainer.classList.remove('hidden');
                    // Refatora√ß√£o da Tarefa 3: S√≥ mostra painel se estiver dentro de um cliente
                    adminPanelBtn.classList.toggle('hidden', !state.currentClientId);
                } else {
                    adminPanelBtn.classList.add('hidden');
                    toggleContainer.classList.add('hidden');
                }

                // --- L√ìGICA DE EXIBI√á√ÉO DO LOGO DO CLIENTE ---
                const headerLogoImg = document.getElementById('header-client-logo');
                const headerClientNameSpan = document.getElementById('header-client-name');
                let clientForHeader = null;

                const clientIdToShow = state.isAdmin ? state.currentClientId : state.user.user_metadata.clientId;

                if (clientIdToShow && state.clients.length > 0) {
                    clientForHeader = state.clients.find(c => c.id === clientIdToShow);
                } else if (clientIdToShow && state.projects.length > 0) {
                    const projectFromClient = state.projects.find(p => p.client_id === clientIdToShow);
                    if (projectFromClient && projectFromClient.laborai_clients) {
                        clientForHeader = projectFromClient.laborai_clients;
                    }
                }

                if (clientForHeader && clientForHeader.logo_url) {
                    headerLogoImg.src = clientForHeader.logo_url.replace('/view', '/uc');
                    headerLogoImg.classList.remove('hidden');
                    headerClientNameSpan.textContent = `| ${clientForHeader.name}`;
                } else if (clientForHeader) {
                    headerLogoImg.classList.add('hidden');
                    headerClientNameSpan.textContent = `| ${clientForHeader.name}`;
                } else {
                    headerLogoImg.classList.add('hidden');
                    headerClientNameSpan.textContent = state.isAdmin ? (state.isSimulatingClient ? " (Modo Visualiza√ß√£o)" : " | Admin") : "";
                }
            }

            // 2. LISTA DE CLIENTES
            function renderClientList() {
                const container = document.getElementById('clients-list');
                container.innerHTML = '';
                
                state.clients.forEach(client => {
                    const card = document.createElement('div');
                    card.className = 'client-card';
                    card.onclick = (e) => {
                        if (e.target.tagName === 'BUTTON') return;
                        openClientProjects(client.id);
                    };

                    const logoHtml = client.logo_url 
                        ? `<img src="${client.logo_url.replace('/view', '/uc')}" class="client-logo-thumb">`
                        : `<div style="width:40px; height:40px; background:#374151; border-radius:4px; display:flex; align-items:center; justify-content:center; font-weight:bold;">${client.name.substring(0,2).toUpperCase()}</div>`;

                    card.innerHTML = `
                        <div class="card-header">
                            <div>
                                <h4 style="margin:0;">${client.name}</h4>
                                <small style="color:var(--text-secondary)">ID: ${client.id.split('-')[0]}...</small>
                            </div>
                            ${logoHtml}
                        </div>
                        <div style="margin-top: 15px; border-top: 1px solid var(--border-dark); padding-top: 10px;">
                            <button class="secondary" style="width: 100%;" onclick="openClientProjects('${client.id}')">üìÇ Ver Projetos &rarr;</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // 3. LISTA DE PROJETOS
            function renderProjectList(clientId = null) {
                const container = document.getElementById('project-list-content');
                container.innerHTML = '';
                
                let filteredProjects = state.projects;
                
                if (state.isAdmin) {
                    if (clientId) {
                        filteredProjects = state.projects.filter(p => p.client_id === clientId);
                        document.getElementById('back-to-clients-button').classList.remove('hidden');
                    } else {
                        document.getElementById('back-to-clients-button').classList.add('hidden');
                    }
                } else {
                    document.getElementById('back-to-clients-button').classList.add('hidden');
                }

                if (filteredProjects.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1;">Nenhum projeto encontrado.</p>';
                    return;
                }

                filteredProjects.forEach(project => {
                    const latestVersion = project.laborai_project_versions?.[0];
                    const progress = latestVersion?.progress_percentage || 0;
                    
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.onclick = () => openProjectDetail(project.id); // O card inteiro agora √© o link

                    const description = project.description || 'Sem descri√ß√£o';
                    const shortDesc = description.length > 120 ? description.substring(0, 120) + '...' : description;

                    let adminActions = '';
                    if (state.isAdmin && !state.isSimulatingClient) {
                        adminActions = `
                            <div class="admin-toolbar" style="margin-top: 15px; border-top: 1px solid var(--border-dark); padding-top: 10px;">
                                <button class="secondary icon-btn" onclick="event.stopPropagation(); handleEditProject(${JSON.stringify(project)})">‚úèÔ∏è Editar</button>
                                <button class="danger icon-btn" onclick="event.stopPropagation(); handleDeleteProject('${project.id}')">üóëÔ∏è</button>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <div>
                            <h4 style="margin: 0 0 5px 0;">${project.name}</h4>
                            <small style="color: var(--text-secondary);">${shortDesc}</small>
                            <div style="margin: 10px 0;">
                                <div style="display:flex; justify-content:space-between; font-size:0.85em; margin-bottom:4px;">
                                    <span>Progresso</span>
                                    <span>${progress}%</span>
                                </div>
                                <div style="height:6px; background:#374151; border-radius:3px; overflow:hidden;">
                                    <div style="height:100%; width:${progress}%; background: var(${progress > 99 ? '--success-color' : '--primary-accent'});"></div>
                                </div>
                            </div>
                            <small style="color: var(--text-secondary);">Vers√£o Atual: ${latestVersion ? latestVersion.version_number : 'v1.0'}</small>
                        </div>
                        ${adminActions}
                    `;
                    container.appendChild(card);
                });
            }

            // 4. DETALHES DO PROJETO (TIMELINE)
            function renderProjectDetail(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) return;

                // Dentro de renderProjectDetail, ap√≥s encontrar o objeto 'project'
                document.getElementById('project-detail-description').innerText = project.description || 'Nenhuma descri√ß√£o fornecida.';

                state.currentProjectId = projectId;
                document.getElementById('project-detail-name').innerText = project.name;
                
                const versions = project.laborai_project_versions || [];
                versions.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                
                const contentDiv = document.getElementById('project-detail-content');
                contentDiv.innerHTML = '';

                // NOVA L√ìGICA DE VISIBILIDADE E POPULA√á√ÉO
                const activeVersion = versions[0]; // Vers√£o mais recente
                state.currentVersionId = activeVersion ? activeVersion.id : null;
                const progress = activeVersion?.progress_percentage || 0;

                // Popula a barra de progresso visual que √© para todos
                document.getElementById('progress-percentage-display').innerText = `${progress}%`;
                const progressBarFill = document.getElementById('progress-bar-fill');
                progressBarFill.style.width = `${progress}%`;
                // Muda a cor para verde quando conclu√≠do
                progressBarFill.style.backgroundColor = progress >= 100 ? 'var(--success-color)' : 'var(--primary-accent)';

                // Controle de visibilidade dos elementos de admin
                const isAdminMode = state.isAdmin && !state.isSimulatingClient;
                document.getElementById('admin-progress-controls').classList.toggle('hidden', !isAdminMode);

                // Configura o slider e o form apenas se for admin
                if (isAdminMode && activeVersion) {
                    const progressSlider = document.getElementById('progress-slider');
                    progressSlider.value = progress;
                    
                    // Popula o select de fases para o formul√°rio de atualiza√ß√£o
                    const phaseSelect = document.getElementById('update-phase-select');
                    phaseSelect.innerHTML = '';
                    activeVersion.laborai_project_phases.forEach(ph => {
                        const opt = document.createElement('option');
                        opt.value = ph.id; 
                        opt.innerText = ph.name;
                        phaseSelect.appendChild(opt);
                    });
                }

                // A l√≥gica para ocultar/mostrar o form de Nova Atualiza√ß√£o continua a mesma.
                document.getElementById('toggle-add-update-form').classList.toggle('hidden', !isAdminMode);

                // Pausa a feature de m√∫ltiplas vers√µes, renderizando apenas a mais recente.
                if (activeVersion) {
                    const version = activeVersion; // usa a vari√°vel 'version' para compatibilidade com o c√≥digo interno do loop
                    const vDiv = document.createElement('div');
                    
                    const phases = version.laborai_project_phases.sort((a,b) => a.phase_order - b.phase_order);
                    
                    phases.forEach(phase => {
                        const isCompleted = phase.status === 'completed';
                        const isInProgress = phase.status === 'in_progress';
                        
                        const pHeader = document.createElement('div');
                        pHeader.className = `phase-header ${isInProgress ? 'active' : ''}`;
                        pHeader.style.borderColor = isCompleted ? 'var(--success-color)' : (isInProgress ? 'var(--primary-accent)' : 'var(--border-dark)');
                        
                        pHeader.onclick = (e) => {
                            if (e.target.tagName !== 'BUTTON') {
                                pHeader.classList.toggle('expanded');
                            }
                        };

                        let phaseActions = '';
                        if (isAdminMode) {
                            const status = phase.status;
                            let startPauseButton = '';
                            let completeReopenButton = '';

                            if (status === 'pending') {
                                // Se est√° pendente, pode iniciar.
                                startPauseButton = `<button class="icon-btn secondary" title="Marcar como 'Em Andamento'" onclick="changePhaseStatus('${phase.id}', 'in_progress')">‚ñ∂ Iniciar</button>`;
                            } else if (status === 'in_progress') {
                                // Se est√° em andamento, pode pausar (voltar para pendente) ou concluir.
                                startPauseButton = `<button class="icon-btn secondary" title="Pausar e voltar para 'Pendente'" onclick="changePhaseStatus('${phase.id}', 'pending')">|| Pausar</button>`;
                                completeReopenButton = `<button class="icon-btn secondary" style="background-color: rgba(34, 197, 94, 0.1); color: var(--success-color);" title="Concluir Fase" onclick="changePhaseStatus('${phase.id}', 'completed')">‚úÖ Concluir</button>`;
                            } else if (status === 'completed') {
                                // Se est√° conclu√≠do, pode reabrir (voltar para em andamento).
                                completeReopenButton = `<button class="icon-btn secondary" title="Reabrir Fase (volta para 'Em Andamento')" onclick="changePhaseStatus('${phase.id}', 'in_progress')">‚Ü©Ô∏è Reabrir</button>`;
                            }
                            
                            phaseActions = `
                                <div class="phase-actions" style="display:flex; gap:8px;">
                                    ${startPauseButton}
                                    ${completeReopenButton}
                                </div>
                            `;
                        }

                        pHeader.innerHTML = `
                            <div>
                                <h4 style="margin:0;">${phase.name}</h4>
                                <small style="color:${isCompleted ? 'var(--success-color)' : (isInProgress ? 'var(--primary-accent)' : 'var(--text-secondary)')}">
                                    ${phase.status === 'pending' ? 'Pendente' : phase.status === 'in_progress' ? 'Em Andamento' : 'Conclu√≠do'}
                                </small>
                            </div>
                            ${phaseActions}
                        `;
                        vDiv.appendChild(pHeader);

                        // Container Acorde√£o
                        const pContent = document.createElement('div');
                        pContent.className = 'phase-content';

                        const updates = phase.laborai_phase_updates.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                        updates.forEach(upd => {
                            const uDiv = document.createElement('div');
                            uDiv.className = 'update';
                            
                            let content = `<p style="margin-top:5px;">${upd.description || ''}</p>`;
                            // BLOCO NOVO COM LIGHTBOX
                            if (upd.update_type === 'image' && upd.content_url) {
                                const directImageUrl = getGoogleDriveDirectImage(upd.content_url);
                                if (directImageUrl) {
                                    // Escapa o objeto 'upd' para uso seguro no HTML
                                    const safeUpd = JSON.stringify(upd).replace(/'/g, "&apos;");
                                    content += `<img src="${directImageUrl}" onclick='openImageLightbox(${safeUpd})'>`;
                                } else {
                                    content += `<a href="${upd.content_url}" target="_blank" style="color:var(--primary-accent); display:block; margin-top:5px;">üîó Acessar Anexo (Formato Inv√°lido)</a>`;
                                }
                            } else if (upd.content_url) {
                                content += `<a href="${upd.content_url}" target="_blank" style="color:var(--primary-accent); display:block; margin-top:5px;">üîó Acessar Link</a>`;
                            }

                            let updActions = '';
                            if (isAdminMode) {
                                const safeUpd = JSON.stringify(upd).replace(/'/g, "&apos;");
                                updActions = `
                                    <div class="update-actions">
                                        <button class="icon-btn secondary" title="Editar" onclick='handleEditUpdate(${safeUpd})'>‚úèÔ∏è</button>
                                        <button class="icon-btn" style="background:#25D366; color:white;" title="Notificar WhatsApp" onclick="notifyWhatsApp('${upd.id}', '${project.id}')">üì±</button>
                                        <button class="icon-btn danger" title="Excluir" onclick="deleteUpdate('${upd.id}')">üóëÔ∏è</button>
                                    </div>
                                `;
                            }

                            uDiv.innerHTML = `
                                ${updActions}
                                <strong>${upd.title}</strong>
                                <small style="display:block; color:var(--text-secondary);">${new Date(upd.created_at).toLocaleString('pt-BR')}</small>
                                ${content}
                            `;
                            pContent.appendChild(uDiv);
                        });
                        vDiv.appendChild(pContent);
                    });
                    
                    contentDiv.appendChild(vDiv);
                }
            }

            // --- FUN√á√ïES DE NAVEGA√á√ÉO E L√ìGICA ---

            window.openClientProjects = (clientId) => {
                state.currentClientId = clientId;
                renderHeader();
                renderProjectList(clientId);
                showView('projectList');
            };

            window.openProjectDetail = (projectId) => {
                renderProjectDetail(projectId);
                showView('projectDetail');
            };

            document.getElementById('client-view-toggle').addEventListener('change', (e) => {
                state.isSimulatingClient = e.target.checked;
                renderHeader();
                if (!document.getElementById('project-detail-view').classList.contains('hidden')) {
                    renderProjectDetail(state.currentProjectId);
                } else if (!document.getElementById('client-list-view').classList.contains('hidden')) {
                    renderClientList();
                } else if (!document.getElementById('project-list-view').classList.contains('hidden')) {
                    renderProjectList(state.currentClientId);
                }
            });

            document.getElementById('image-lightbox').addEventListener('click', (e) => {
                // Fecha somente se o clique for no fundo (o modal em si) e n√£o nos seus filhos
                if (e.target.id === 'image-lightbox') {
                    e.target.classList.add('hidden');
                }
            });

            // Refatora√ß√£o: Bot√£o de Adicionar Atualiza√ß√£o abre Modal
            document.getElementById('toggle-add-update-form').addEventListener('click', () => {
                const formContainer = document.getElementById('add-update-form-container');
                showGenericModal({
                    title: 'Adicionar Nova Atualiza√ß√£o',
                    bodyHtml: formContainer.innerHTML, // Clona o HTML do formul√°rio
                    buttons: [] // Sem bot√µes extras, o form tem o submit
                });

                // Re-atacha o listener de submit ao formul√°rio dentro do modal
                const modalForm = document.querySelector('#generic-modal #add-update-form');
                if(modalForm) {
                    modalForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const btn = modalForm.querySelector('button[type="submit"]');
                        btn.disabled = true; btn.innerText = 'Salvando...';

                        try {
                            const formData = new FormData();
                            formData.append('phaseId', modalForm.querySelector('#update-phase-select').value);
                            formData.append('title', modalForm.querySelector('#update-title').value);
                            formData.append('description', modalForm.querySelector('#update-description').value);
                            formData.append('link', modalForm.querySelector('#update-link').value);
                            formData.append('file', modalForm.querySelector('#update-file').files[0]);

                            await handleSaveUpdate(formData);
                            
                            Toast.success('Atualiza√ß√£o criada!');
                            await loadData();
                            renderProjectDetail(state.currentProjectId);
                            document.getElementById('generic-modal').classList.add('hidden');
                        } catch (err) {
                            Toast.error('Falha ao salvar. Verifique os dados.');
                            btn.disabled = false; btn.innerText = 'Publicar Atualiza√ß√£o';
                        }
                    };
                }
            });

            // --- FUN√á√ïES ADMIN / ACTIONS (Via N8N & Modal Customizado) ---

            async function handleSaveUpdate(formData, updateId = null) {
                // Constr√≥i a URL com todos os dados como query params
                let url = `${HOOKS.SALVAR_ATUALIZACAO}?title=${encodeURIComponent(formData.get('title'))}&description=${encodeURIComponent(formData.get('description'))}&contentUrl=${encodeURIComponent(formData.get('link'))}`;
                
                if (updateId) {
                    url += `&updateId=${updateId}`; // Identifica que √© uma edi√ß√£o
                } else {
                    url += `&phaseId=${formData.get('phaseId')}`; // Identifica que √© uma cria√ß√£o
                }

                let fetchOptions = { method: 'POST' };
                const file = formData.get('file');

                if (file && file.size > 0) {
                    url += `&fileName=${encodeURIComponent(file.name)}`;
                    fetchOptions.body = file; // Envia o arquivo no corpo
                }
                
                await fetch(url, fetchOptions);
            }

            // 1. WhatsApp Notification
            window.notifyWhatsApp = async (updateId, projectId) => {
                showGenericModal({
                    title: 'Enviar Notifica√ß√£o',
                    bodyHtml: '<p>Deseja enviar notifica√ß√£o via WhatsApp para todos os contatos deste cliente?</p>',
                    buttons: [{
                        label: 'Enviar',
                        classes: 'primary', 
                        onClick: async () => {
                            await fetch(HOOKS.NOTIFICAR_WHATSAPP, { 
                                method: 'POST', body: JSON.stringify({ updateId, projectId }) 
                            });
                            Toast.success('Notifica√ß√£o enviada!');
                        }
                    }]
                });
            };

            // 2. Upload Logo
            document.getElementById('upload-logo-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('upload-logo-button');
                const file = document.getElementById('logo-file-input').files[0];
                const clientId = document.getElementById('logo-client-select').value;
                
                btn.innerText = 'Enviando...'; btn.disabled = true;
                
                try {
                    const url = `${HOOKS.ATUALIZAR_LOGO}?clientId=${clientId}&fileName=${encodeURIComponent(file.name)}`;
                    const res = await fetch(url, { method: 'POST', body: file });
                    if(!res.ok) throw new Error();
                    
                    Toast.success('Logo atualizada!');
                    await loadData();
                    if(state.isAdmin) renderClientList();
                } catch(e) { Toast.error('Erro no upload.'); }
                finally { btn.innerText = 'Salvar Logo'; btn.disabled = false; document.getElementById('upload-logo-form').reset(); }
            });

            // 3. Gerenciar Contatos
            window.openContactsModal = async (clientId, clientName) => {
                state.currentManageClientId = clientId;
                document.getElementById('contacts-modal-client-name').innerText = clientName;
                document.getElementById('contacts-modal').classList.remove('hidden');
                
                const listEl = document.getElementById('contacts-list');
                listEl.innerHTML = 'Carregando...';
                
                const { data } = await supabaseClient.from('laborai_client_contacts').select('*').eq('client_id', clientId);
                listEl.innerHTML = '';
                
                if(data) {
                    data.forEach(c => {
                        const item = document.createElement('div');
                        item.className = 'contact-item';
                        item.innerHTML = `
                            <div><strong>${c.name}</strong> (${c.role || '-'})<br><small>${c.whatsapp}</small></div>
                            <button class="danger icon-btn" onclick="deleteContact('${c.id}')">üóëÔ∏è</button>
                        `;
                        listEl.appendChild(item);
                    });
                }
            };

            document.getElementById('add-contact-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('add-contact-btn'); btn.disabled = true;
                try {
                    await fetch(HOOKS.CRIAR_CONTATO, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            clientId: state.currentManageClientId,
                            name: document.getElementById('contact-name').value,
                            role: document.getElementById('contact-role').value,
                            whatsapp: document.getElementById('contact-whatsapp').value
                        })
                    });
                    Toast.success('Contato adicionado!');
                    document.getElementById('add-contact-form').reset();
                    const client = state.clients.find(c => c.id === state.currentManageClientId);
                    openContactsModal(client.id, client.name);
                } catch(e) { Toast.error('Erro ao criar contato'); }
                finally { btn.disabled = false; }
            });

            window.deleteContact = async (id) => {
                showGenericModal({
                    title: 'Excluir Contato',
                    bodyHtml: '<p>Tem certeza que deseja excluir este contato?</p>',
                    buttons: [{
                        label: 'Excluir',
                        classes: 'danger',
                        onClick: async () => {
                            await fetch(HOOKS.EXCLUIR_CONTATO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contactId: id }) });
                            const client = state.clients.find(c => c.id === state.currentManageClientId);
                            openContactsModal(client.id, client.name);
                        }
                    }]
                });
            };

            // 4. CRUD Projeto
            window.handleEditProject = (project) => {
                showGenericModal({
                    title: 'Editar Projeto',
                    bodyHtml: `
                        <label>Nome do projeto:</label>
                        <input type="text" id="edit-project-name" value="${escapeHtml(project.name)}" required style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
                        <label>Descri√ß√£o:</label>
                        <textarea id="edit-project-description" rows="4" placeholder="Adicione uma descri√ß√£o detalhada..." style="width: 100%; box-sizing: border-box;">${escapeHtml(project.description || '')}</textarea>
                    `,
                    buttons: [{
                        label: 'Salvar',
                        classes: 'primary',
                        onClick: async () => {
                            const newName = document.getElementById('edit-project-name').value;
                            const newDescription = document.getElementById('edit-project-description').value;

                            const updates = [
                                { field: 'name', value: newName },
                                { field: 'description', value: newDescription }
                            ];

                            await fetch(HOOKS.EDITAR_PROJETO, { 
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ projectId: project.id, updates }) 
                            });
                            
                            Toast.success('Projeto atualizado');
                            await loadData(); 
                            renderProjectList(state.currentClientId);
                        }
                    }]
                });
            };

            window.handleDeleteProject = async (projectId) => {
                showGenericModal({
                    title: 'Confirmar Exclus√£o',
                    bodyHtml: '<p style="color:var(--error-color);">ATEN√á√ÉO: Isso excluir√° o projeto e todo o hist√≥rico. Esta a√ß√£o n√£o pode ser desfeita.</p>',
                    buttons: [{
                        label: 'Excluir Projeto',
                        classes: 'danger',
                        onClick: async () => {
                            await fetch(HOOKS.EXCLUIR_PROJETO, { 
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ projectId }) 
                            });
                            Toast.success('Projeto exclu√≠do');
                            await loadData(); 
                            renderProjectList(state.currentClientId);
                        }
                    }]
                });
            };

            window.handleEditUpdate = async (update) => {
                showGenericModal({
                    title: 'Editar Atualiza√ß√£o',
                    bodyHtml: `
                        <label>T√≠tulo:</label>
                        <input type="text" id="edit-update-title" value="${escapeHtml(update.title)}" required style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
                        <label>Descri√ß√£o:</label>
                        <textarea id="edit-update-desc" rows="4" style="width: 100%; box-sizing: border-box;">${escapeHtml(update.description || '')}</textarea>
                        <label>Link (deixe em branco para remover):</label>
                        <input type="url" id="edit-update-link" value="${update.update_type === 'link' ? escapeHtml(update.content_url) : ''}" placeholder="https://..." style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
                        <label for="edit-update-file" style="font-size: 0.9em; color: var(--text-secondary);">Substituir Arquivo (opcional):</label>
                        ${update.update_type === 'image' && update.content_url ? `<img src="${update.content_url}" style="max-width:100px; display:block; margin-bottom:5px;">` : ''}
                        <input type="file" id="edit-update-file">
                    `,
                    buttons: [{
                        label: 'Salvar Altera√ß√µes',
                        classes: 'primary',
                        onClick: async () => {
                            const formData = new FormData();
                            formData.append('title', document.getElementById('edit-update-title').value);
                            formData.append('description', document.getElementById('edit-update-desc').value);
                            formData.append('link', document.getElementById('edit-update-link').value);
                            formData.append('file', document.getElementById('edit-update-file').files[0]);

                            await handleSaveUpdate(formData, update.id);
                            
                            Toast.success('Atualiza√ß√£o salva!');
                            await loadData();
                            renderProjectDetail(state.currentProjectId);
                        }
                    }]
                });
            };

            window.deleteUpdate = async (updateId) => {
                showGenericModal({
                    title: 'Excluir Atualiza√ß√£o',
                    bodyHtml: '<p>Deseja remover esta atualiza√ß√£o da timeline?</p>',
                    buttons: [{
                        label: 'Excluir',
                        classes: 'danger',
                        onClick: async () => {
                            await fetch(HOOKS.EXCLUIR_ATUALIZACAO, { 
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ updateId }) 
                            });
                            Toast.success('Atualiza√ß√£o removida');
                            await loadData(); 
                            renderProjectDetail(state.currentProjectId);
                        }
                    }]
                });
            };

            // 6. Status da Fase
            window.changePhaseStatus = async (phaseId, status) => {
                await fetch(HOOKS.ATUALIZAR_STATUS_FASE, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ phaseId, newStatus: status })
                });
                Toast.success('Status da fase alterado');
                await loadData(); 
                renderProjectDetail(state.currentProjectId);
            };

            // --- OUTROS FORMUL√ÅRIOS (Refatorados para Auto-Refresh) ---
            
            // Login
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email: document.getElementById('login-email').value, 
                    password: document.getElementById('login-password').value 
                });
                if (error) Toast.error(error.message);
                else initApp(data.user);
            });

            document.getElementById('logout-button').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.reload();
            });

            // Navega√ß√£o Admin Panel
            document.getElementById('admin-panel-button').addEventListener('click', () => {
                populateDropdowns();
                showView('adminForms');
            });
            document.getElementById('back-from-admin-panel').addEventListener('click', () => {
                renderProjectList(state.currentClientId); // Refatora√ß√£o Tarefa 3: Voltar para lista de projetos do cliente
                showView('projectList');
            });

            // Criar Cliente
            document.getElementById('create-client-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-client-name').value;
                await fetch(HOOKS.CRIAR_CLIENTE, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ clientName: name }) });
                Toast.success('Cliente criado'); 
                e.target.reset(); 
                await loadData(); 
                populateDropdowns();
            });

            // Criar Projeto
            document.getElementById('phase-template-select').addEventListener('change', (e) => {
                const isCustom = e.target.value === 'Customizado';
                document.getElementById('new-project-phases').classList.toggle('hidden', !isCustom);
            });
            
            document.getElementById('create-project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const phasesRaw = document.getElementById('new-project-phases').value;
                const template = state.phaseTemplates.find(t => t.name === document.getElementById('phase-template-select').value);
                const phases = template.name === 'Customizado' ? phasesRaw.split('\n') : template.phases;

                await fetch(HOOKS.CRIAR_PROJETO, { 
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ 
                        clientId: document.getElementById('project-client-select').value,
                        projectName: document.getElementById('new-project-name').value,
                        description: document.getElementById('new-project-description').value,
                        phases 
                    })
                });
                Toast.success('Projeto criado'); 
                e.target.reset(); 
                await loadData();
            });

            // Save Progress
            document.getElementById('progress-slider').addEventListener('input', (e) => document.getElementById('progress-percentage-display').innerText = e.target.value + '%');
            document.getElementById('save-progress-button').addEventListener('click', async () => {
                const val = document.getElementById('progress-slider').value;
                await fetch(HOOKS.ATUALIZAR_PROGRESSO, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ versionId: state.currentVersionId, newProgress: parseInt(val) })
                });
                Toast.success('Progresso salvo');
                await loadData();
                renderProjectDetail(state.currentProjectId); // Re-render to confirm the change
            });
            
            // Navega√ß√£o de Voltar
            document.getElementById('back-to-clients-button').addEventListener('click', () => {
                state.currentClientId = null;
                renderHeader();
                showView('clientList');
            });
            document.getElementById('back-to-projects-button').addEventListener('click', () => {
                renderProjectList(state.currentClientId);
                showView('projectList');
            });

            function populateDropdowns() {
                const logoSel = document.getElementById('logo-client-select');
                const projSel = document.getElementById('project-client-select');
                const userSel = document.getElementById('user-client-select');
                [logoSel, projSel, userSel].forEach(s => s.innerHTML = '<option value="">Selecione...</option>');
                
                state.clients.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c.id; opt.innerText = c.name;
                    [logoSel, projSel, userSel].forEach(s => s.appendChild(opt.cloneNode(true)));
                });

                const tmplSel = document.getElementById('phase-template-select');
                tmplSel.innerHTML = '';
                state.phaseTemplates.forEach(t => {
                    const opt = document.createElement('option'); opt.value = t.name; opt.innerText = t.name;
                    tmplSel.appendChild(opt);
                });
            }

            // --- INIT ---
            async function initApp(user) {
                state.user = user;
                state.isAdmin = user.user_metadata.role === 'admin';
                
                await loadData();
                renderHeader();
                showView('app');

                if (state.isAdmin) {
                    renderClientList();
                    showView('clientList');
                } else {
                    renderProjectList(user.user_metadata.clientId);
                    showView('projectList');
                }
            }

            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) initApp(session.user);
                else showView('login');
            });
        });
    </script>
</body>
</html>
