<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Projetos - LaborAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --background-dark: #111827; --surface-dark: #1f2937; --border-dark: #374151;
            --primary-accent: #3b82f6; --primary-accent-hover: #60a5fa; --text-primary: #f9fafb;
            --text-secondary: #9ca3af; --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-dark); color: var(--text-primary); margin: 0; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Login */
        #login-section { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-card { background: var(--surface-dark); padding: 40px; border-radius: 12px; border: 1px solid var(--border-dark); width: 100%; max-width: 400px; text-align: center; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--border-dark); border-radius: 6px; box-sizing: border-box; background-color: #374151; color: var(--text-primary); font-size: 16px; font-family: 'Inter', sans-serif; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; background-color: var(--primary-accent); color: white; font-weight: 500; font-size: 16px; cursor: pointer; transition: background-color 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        button:hover { background-color: var(--primary-accent-hover); }
        button:disabled { background-color: #4b5563; cursor: not-allowed; }
        
        /* Button Variants */
        button.secondary { background: transparent; border: 1px solid var(--border-dark); color: var(--text-primary); }
        button.secondary:hover { background: var(--border-dark); }
        button.danger { background-color: rgba(239, 68, 68, 0.2); color: var(--error-color); border: 1px solid var(--error-color); }
        button.danger:hover { background-color: rgba(239, 68, 68, 0.3); }
        button.primary { /* Padr√£o, mas explicito se necess√°rio via JS */ } 
        button.icon-btn { width: auto; padding: 6px 10px; font-size: 14px; }
        
        /* Header */
        #app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border-dark); margin-bottom: 24px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .client-logo-header-img { height: 32px; object-fit: contain; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-right: 20px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .project-card, .client-card { background: var(--surface-dark); padding: 20px; border-radius: 8px; border: 1px solid var(--border-dark); cursor: pointer; transition: transform 0.2s, border-color 0.2s; position: relative; }
        .project-card:hover, .client-card:hover { transform: translateY(-3px); border-color: var(--primary-accent); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .client-logo-thumb { height: 40px; max-width: 100px; object-fit: contain; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 4px; }
        
        /* Timeline/Details */
        .phase-header { border: 2px solid var(--border-dark); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--surface-dark); display: flex; justify-content: space-between; align-items: center; }
        .phase-header.active { border-color: var(--primary-accent); animation: pulse-border 3s infinite; }
        .update { margin-left: 20px; margin-bottom: 12px; padding: 15px; background: var(--background-dark); border-left: 3px solid var(--border-dark); border-radius: 0 8px 8px 0; position: relative; }
        .update-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; opacity: 0.7; }
        .update-actions:hover { opacity: 1; }
        
        /* Admin Sections */
        .admin-section-card { border: 1px solid var(--border-dark); border-radius: 8px; padding: 20px; margin-top: 20px; background: var(--surface-dark); }
        .admin-toolbar { display: flex; gap: 8px; margin-top: 10px; }
        
        /* Toast */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.75rem; max-width: 420px; }
        .toast { padding: 1rem 1.25rem; border-radius: 8px; background-color: var(--surface-dark); border-left: 4px solid; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
        .toast.success { border-color: var(--success-color); } .toast.error { border-color: var(--error-color); } .toast.info { border-color: var(--primary-accent); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* Modals */
        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface-dark); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; border: 1px solid var(--border-dark); max-height: 90vh; overflow-y: auto; }
        
        /* Contacts List in Modal */
        .contact-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-dark); }
        .contact-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- TELA DE LOGIN -->
    <div id="login-section">
        <div class="login-card">
            <h2>Portal LaborAI</h2>
            <p>Acesse para gerenciar seus projetos.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" placeholder="Sua senha" required>
                <button type="submit">Entrar</button>
            </form>
        </div>
    </div>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div id="app-container" class="container hidden">
        <header id="app-header">
            <div class="header-left">
                <!-- Logo do Cliente (Carregada Dinamicamente) -->
                <img id="header-client-logo" class="client-logo-header-img hidden" alt="Logo">
                <div>
                    <strong style="font-size: 1.2rem;">LaborAI</strong>
                    <span id="header-client-name" style="color: var(--text-secondary); margin-left: 8px;"></span>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                
                <!-- Toggle "Ver como Cliente" (Apenas Admin) -->
                <div id="admin-simulation-toggle" class="toggle-container hidden">
                    <span style="font-size: 0.9em; color: var(--text-secondary);">Ver como Cliente</span>
                    <label class="switch">
                        <input type="checkbox" id="client-view-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <span id="user-email" style="font-size: 0.9em; margin-right: 16px; color: var(--text-secondary);"></span>
                
                <!-- Bot√£o Painel Admin (Apenas Admin) -->
                <button id="admin-panel-button" class="hidden" style="width: auto; padding: 6px 12px; margin-right: 10px; background-color: var(--surface-dark); border: 1px solid var(--warning-color); color: var(--warning-color);">
                    ‚öôÔ∏è Painel & Cria√ß√£o
                </button>
                
                <button id="logout-button" class="secondary" style="width: auto; padding: 6px 12px;">Sair</button>
            </div>
        </header>

        <main id="main-content">
            <!-- VIEW 1: Lista de Clientes (Home do Admin) -->
            <div id="client-list-view" class="hidden">
                <h3>Meus Clientes</h3>
                <div id="clients-list" class="card-grid"></div>
            </div>

            <!-- VIEW 2: Lista de Projetos (Home do Cliente / Navega√ß√£o Admin) -->
            <div id="project-list-view" class="hidden">
                <button id="back-to-clients-button" class="secondary hidden" style="margin-bottom: 20px;">&larr; Voltar para Clientes</button>
                
                <!-- Header da View 2 -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-dark); padding-bottom: 16px;">
                    <h2 id="project-list-title" style="margin: 0;">Projetos</h2>
                    <button id="manage-contacts-btn" class="secondary icon-btn hidden" style="font-size: 15px;">üë• Gerenciar Contatos</button>
                </div>
                
                <div id="project-list-content" class="card-grid"></div>
            </div>

            <!-- VIEW 3: Detalhes do Projeto (Timeline) -->
            <div id="project-detail-view" class="hidden">
                <button id="back-to-projects-button" class="secondary" style="margin-bottom: 20px;">&larr; Voltar para Projetos</button>
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <h2 id="project-detail-name">Nome do Projeto</h2>
                </div>

                <!-- Admin Controls: Progresso -->
                <div id="progress-control-container" class="admin-section-card hidden">
                    <h3>üìä Controle de Progresso</h3>
                    <div id="progress-display"></div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <input type="range" min="0" max="100" value="0" id="progress-slider" style="flex: 1;">
                        <span id="slider-value" style="font-weight: bold; width: 40px;">0%</span>
                        <button id="save-progress-button" style="width: auto;">Salvar</button>
                    </div>
                </div>

                <!-- Conte√∫do da Timeline -->
                <div id="project-detail-content" style="margin-top: 24px;"></div>

                <!-- Admin Controls: Adicionar Atualiza√ß√£o (REFATORADO) -->
                <div id="add-update-form-container" class="admin-section-card hidden">
                    <h3>Nova Atualiza√ß√£o</h3>
                    <form id="add-update-form">
                        <select id="update-phase-select" required></select>
                        <input type="text" id="update-title" placeholder="T√≠tulo da atualiza√ß√£o" required>
                        <textarea id="update-description" rows="3" placeholder="Descri√ß√£o detalhada... (Obrigat√≥rio)"></textarea>
                        <input type="url" id="update-link" placeholder="Anexar Link (Opcional, ex: https://...)">
                        <label for="update-file" style="font-size: 0.9em; color: var(--text-secondary);">Anexar Imagem (Opcional):</label>
                        <input type="file" id="update-file" accept="image/*">
                        <button type="submit" id="add-update-button">Publicar Atualiza√ß√£o</button>
                    </form>
                </div>
            </div>

            <!-- VIEW 4: Painel Administrativo (Formul√°rios de Cria√ß√£o) -->
            <div id="admin-forms-view" class="hidden">
                <button id="back-from-admin-panel" class="secondary" style="margin-bottom: 20px;">&larr; Voltar</button>
                <h2>Painel de Gest√£o & Cria√ß√£o</h2>
                
                <div class="card-grid">
                    <!-- Upload de Logo -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üñºÔ∏è Logo do Cliente</h3>
                        <form id="upload-logo-form">
                            <label>Cliente:</label>
                            <select id="logo-client-select" required></select>
                            <label>Arquivo (PNG/JPG/SVG):</label>
                            <input type="file" id="logo-file-input" accept="image/png, image/jpeg, image/svg+xml" required>
                            <button type="submit" id="upload-logo-button">Salvar Logo</button>
                        </form>
                    </div>

                    <!-- Criar Cliente -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üè¢ Novo Cliente</h3>
                        <form id="create-client-form">
                            <label>Nome da Empresa:</label>
                            <input type="text" id="new-client-name" placeholder="Ex: Molas Fama" required>
                            <button type="submit" id="create-client-button">Criar Cliente</button>
                        </form>
                    </div>

                    <!-- Criar Usu√°rio -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üë§ Novo Usu√°rio</h3>
                        <form id="create-user-form">
                            <label>Associar ao Cliente:</label>
                            <select id="user-client-select" required></select>
                            <label>E-mail:</label>
                            <input type="email" id="new-user-email" required>
                            <label>Senha Provis√≥ria:</label>
                            <input type="password" id="new-user-password" required>
                            <button type="submit" id="create-user-button">Criar Usu√°rio</button>
                        </form>
                    </div>
                </div>

                <!-- Criar Projeto -->
                <div class="admin-section-card">
                    <h3>üöÄ Novo Projeto</h3>
                    <form id="create-project-form">
                        <label>Cliente:</label>
                        <select id="project-client-select" required></select>
                        <label>Nome do Projeto:</label>
                        <input type="text" id="new-project-name" required>
                        <label>Descri√ß√£o:</label>
                        <textarea id="new-project-description" rows="2"></textarea>
                        <label>Template de Fases:</label>
                        <select id="phase-template-select" required></select>
                        <textarea id="new-project-phases" rows="4" class="hidden" placeholder="Fase 1..."></textarea>
                        <button type="submit" id="create-project-button">Criar Projeto</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: Nova Vers√£o -->
    <div id="new-version-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Iniciar Nova Vers√£o</h3>
            <form id="new-version-form">
                <input type="text" id="new-version-number" placeholder="Ex: V2.0" required>
                <textarea id="new-version-summary" rows="3" placeholder="Resumo das mudan√ßas..." required></textarea>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="secondary" onclick="document.getElementById('new-version-modal').classList.add('hidden')">Cancelar</button>
                    <button type="submit">Criar Vers√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Gerenciar Contatos -->
    <div id="contacts-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Gerenciar Contatos</h3>
            <p id="contacts-modal-client-name" style="color: var(--text-secondary); margin-bottom: 15px;"></p>
            
            <!-- Lista -->
            <div id="contacts-list" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-dark); border-radius: 6px;">
                <!-- Itens inseridos via JS -->
            </div>

            <!-- Adicionar Novo -->
            <h4 style="border-top: 1px solid var(--border-dark); padding-top: 15px;">Adicionar Novo</h4>
            <form id="add-contact-form">
                <input type="text" id="contact-name" placeholder="Nome" required style="margin-bottom: 8px;">
                <input type="text" id="contact-role" placeholder="Cargo" style="margin-bottom: 8px;">
                <input type="text" id="contact-whatsapp" placeholder="WhatsApp (55119...)" required style="margin-bottom: 8px;">
                <button type="submit" id="add-contact-btn">Adicionar Contato</button>
            </form>
            <button class="secondary" onclick="document.getElementById('contacts-modal').classList.add('hidden')" style="margin-top: 15px; width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA A√á√ïES -->
    <div id="generic-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="modal-title">T√≠tulo Padr√£o</h3>
            <div id="modal-body" style="margin: 20px 0;">
                <!-- Conte√∫do ser√° injetado aqui via JS -->
            </div>
            <div id="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <!-- Bot√µes ser√£o injetados aqui via JS -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURA√á√ÉO ---
            const SUPABASE_URL = 'https://vzmhnponxmrvoqctmpty.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6bWhucG9ueG1ydm9xY3RtcHR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3Mzg5MjYsImV4cCI6MjA3MDMxNDkyNn0.sSfMCpPKwFp2lVLuWnFN066OT0lluMb-sd-kWb1PePg';
            
            // Webhooks do N8N
            const N8N_BASE = 'https://n8n-n8n.znxk1t.easypanel.host/webhook';
            const HOOKS = {
                // Uploads e Cria√ß√£o
                ATUALIZAR_LOGO: `${N8N_BASE}/atualizar-logo-cliente`,
                CRIAR_CLIENTE: `${N8N_BASE}/criar-novo-cliente`,
                CRIAR_USUARIO: `${N8N_BASE}/criar-novo-usuario`,
                CRIAR_PROJETO: `${N8N_BASE}/criar-novo-projeto`,
                ADD_ATUALIZACAO: `${N8N_BASE}/adicionar-atualizacao-fase`,
                ADD_ATUALIZACAO_ARQUIVO: `${N8N_BASE}/adicionar-atualizacao-com-arquivo`,
                
                // Gest√£o de Projeto
                ATUALIZAR_PROGRESSO: `${N8N_BASE}/atualizar-progresso-projeto`,
                ATUALIZAR_STATUS_FASE: `${N8N_BASE}/atualizar-status-fase`,
                CRIAR_NOVA_VERSAO: `${N8N_BASE}/criar-nova-versao`,
                NOTIFICAR_WHATSAPP: `${N8N_BASE}/notificar-whatsapp`,
                
                // CRUD e Gest√£o
                CRIAR_CONTATO: `${N8N_BASE}/criar-contato-cliente`,
                EXCLUIR_CONTATO: `${N8N_BASE}/excluir-contato-cliente`,
                EDITAR_PROJETO: `${N8N_BASE}/editar-projeto`, // Params: projectId, updates (array)
                EXCLUIR_PROJETO: `${N8N_BASE}/excluir-projeto`, // Params: projectId
                EXCLUIR_ATUALIZACAO: `${N8N_BASE}/excluir-atualizacao`, // Params: updateId
                EDITAR_ATUALIZACAO: `${N8N_BASE}/editar-atualizacao`
            };

            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- ESTADO GLOBAL ---
            let state = {
                user: null,
                isAdmin: false,
                isSimulatingClient: false,
                clients: [],
                projects: [],
                contacts: [],
                currentClientId: null,
                currentProjectId: null,
                currentVersionId: null,
                phaseTemplates: [
                    { name: "Padr√£o (3 Fases)", phases: ["Levantamento", "Desenvolvimento", "Valida√ß√£o"] },
                    { name: "Completo (5 Fases)", phases: ["Diagn√≥stico", "Design", "Dev", "Homologa√ß√£o", "Go-Live"] },
                    { name: "Customizado", phases: [] }
                ]
            };

            // --- UTILS ---
            const Toast = {
                container: document.getElementById('toast-container'),
                show(type, msg) {
                    const el = document.createElement('div'); el.className = `toast ${type}`;
                    el.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${msg}</span>`;
                    this.container.appendChild(el);
                    setTimeout(() => el.remove(), 4000);
                },
                success(m) { this.show('success', m); }, error(m) { this.show('error', m); }, info(m) { this.show('info', m); }
            };

            // Fun√ß√£o de escape para strings em HTML
            function escapeHtml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                    .replace(/`/g, "&#96;"); // Importante para template literals
            }

            // Sistema de Modal Gen√©rico
            window.showGenericModal = function({ title, bodyHtml, buttons }) {
                const modal = document.getElementById('generic-modal');
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = bodyHtml;

                const footer = document.getElementById('modal-footer');
                footer.innerHTML = ''; // Limpa bot√µes antigos

                // Bot√£o para fechar o modal
                const closeModal = () => modal.classList.add('hidden');

                // Adiciona um bot√£o de "Cancelar" padr√£o
                const cancelButton = document.createElement('button');
                cancelButton.className = 'secondary';
                cancelButton.innerText = 'Cancelar';
                cancelButton.onclick = closeModal;
                footer.appendChild(cancelButton);

                // Adiciona bot√µes customizados
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.innerText = btnConfig.label;
                    if (btnConfig.classes) button.className = btnConfig.classes;
                    
                    button.onclick = async () => {
                        // Desabilitar bot√£o para evitar duplo clique
                        const originalText = button.innerText;
                        button.disabled = true;
                        button.innerText = '...';
                        try {
                            await btnConfig.onClick();
                            closeModal();
                        } catch (e) {
                            console.error(e);
                            Toast.error("Erro na a√ß√£o");
                        } finally {
                            button.disabled = false;
                            button.innerText = originalText;
                        }
                    };
                    footer.appendChild(button);
                });

                modal.classList.remove('hidden');
            };

            const Views = {
                login: document.getElementById('login-section'),
                app: document.getElementById('app-container'),
                clientList: document.getElementById('client-list-view'),
                projectList: document.getElementById('project-list-view'),
                projectDetail: document.getElementById('project-detail-view'),
                adminForms: document.getElementById('admin-forms-view')
            };

            function showView(viewName) {
                Object.values(Views).forEach(el => { if(el && el !== Views.app) el.classList.add('hidden'); });
                if (viewName !== 'login') Views.app.classList.remove('hidden');
                if (Views[viewName]) Views[viewName].classList.remove('hidden');
            }

            // --- DATA FETCHING (LEITURA via Supabase, ESCRITA via Webhook) ---
            async function loadData() {
                try {
                    // 1. Carregar Projetos
                    let query = supabaseClient.from('laborai_projects').select(`*, laborai_clients(name, logo_url), laborai_project_versions(*, laborai_project_phases(*, laborai_phase_updates(*)))`).order('created_at', { ascending: false });
                    
                    if (!state.isAdmin) {
                        const clientId = state.user.user_metadata.clientId;
                        if (clientId) query = query.eq('client_id', clientId);
                    }
                    
                    const { data: projData, error: projError } = await query;
                    if (projError) throw projError;
                    state.projects = projData;

                    // 2. Carregar Clientes (Apenas Admin)
                    if (state.isAdmin) {
                        const { data: clientData, error: clientError } = await supabaseClient.from('laborai_clients').select('*').order('name');
                        if (clientError) throw clientError;
                        state.clients = clientData;
                    }
                } catch (e) {
                    console.error(e);
                    Toast.error('Erro ao carregar dados: ' + e.message);
                }
            }

            // --- RENDERIZA√á√ÉO ---

            // 1. HEADER
            function renderHeader() {
                document.getElementById('user-email').textContent = state.user.email;
                const adminPanelBtn = document.getElementById('admin-panel-button');
                const toggleContainer = document.getElementById('admin-simulation-toggle');
                
                if (state.isAdmin) {
                    adminPanelBtn.classList.remove('hidden');
                    toggleContainer.classList.remove('hidden');
                } else {
                    adminPanelBtn.classList.add('hidden');
                    toggleContainer.classList.add('hidden');
                }

                // --- L√ìGICA DE EXIBI√á√ÉO DO LOGO DO CLIENTE (ADICIONAR/MODIFICAR) ---
                const headerLogoImg = document.getElementById('header-client-logo');
                const headerClientNameSpan = document.getElementById('header-client-name');
                let clientForHeader = null;

                // Se for admin, o cliente √© o que est√° sendo visualizado.
                // Se for cliente, o clientId vem dos seus metadados.
                const clientIdToShow = state.isAdmin ? state.currentClientId : state.user.user_metadata.clientId;

                if (clientIdToShow && state.clients.length > 0) {
                    clientForHeader = state.clients.find(c => c.id === clientIdToShow);
                } else if (clientIdToShow && state.projects.length > 0) {
                    // Fallback para pegar o cliente dos projetos, caso a lista de clientes n√£o esteja populada (cen√°rio do cliente logado)
                    const projectFromClient = state.projects.find(p => p.client_id === clientIdToShow);
                    if (projectFromClient && projectFromClient.laborai_clients) {
                        clientForHeader = projectFromClient.laborai_clients;
                    }
                }

                if (clientForHeader && clientForHeader.logo_url) {
                    headerLogoImg.src = clientForHeader.logo_url.replace('/view', '/uc');
                    headerLogoImg.classList.remove('hidden');
                    headerClientNameSpan.textContent = `| ${clientForHeader.name}`;
                } else if (clientForHeader) {
                    headerLogoImg.classList.add('hidden');
                    headerClientNameSpan.textContent = `| ${clientForHeader.name}`;
                } else {
                    headerLogoImg.classList.add('hidden');
                    // Para admin na tela principal, mostra "Admin"
                    headerClientNameSpan.textContent = state.isAdmin ? (state.isSimulatingClient ? " (Modo Visualiza√ß√£o)" : " | Admin") : "";
                }
            }

            // 2. LISTA DE CLIENTES
            function renderClientList() {
                const container = document.getElementById('clients-list');
                container.innerHTML = '';
                
                state.clients.forEach(client => {
                    const card = document.createElement('div');
                    card.className = 'client-card';
                    card.onclick = (e) => {
                        if (e.target.tagName === 'BUTTON') return;
                        openClientProjects(client.id);
                    };

                    const logoHtml = client.logo_url 
                        ? `<img src="${client.logo_url.replace('/view', '/uc')}" class="client-logo-thumb">`
                        : `<div style="width:40px; height:40px; background:#374151; border-radius:4px; display:flex; align-items:center; justify-content:center; font-weight:bold;">${client.name.substring(0,2).toUpperCase()}</div>`;

                    card.innerHTML = `
                        <div class="card-header">
                            <div>
                                <h4 style="margin:0;">${client.name}</h4>
                                <small style="color:var(--text-secondary)">ID: ${client.id.split('-')[0]}...</small>
                            </div>
                            ${logoHtml}
                        </div>
                        <div style="margin-top: 15px; border-top: 1px solid var(--border-dark); padding-top: 10px;">
                            <button class="secondary" style="width: 100%;" onclick="openClientProjects('${client.id}')">üìÇ Ver Projetos &rarr;</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // 3. LISTA DE PROJETOS
            function renderProjectList(clientId = null) {
                const container = document.getElementById('project-list-content');
                container.innerHTML = '';
                
                let filteredProjects = state.projects;
                let title = "Meus Projetos";
                const manageContactsBtn = document.getElementById('manage-contacts-btn');

                if (state.isAdmin) {
                    if (clientId) {
                        filteredProjects = state.projects.filter(p => p.client_id === clientId);
                        const client = state.clients.find(c => c.id === clientId);
                        if (client) title = `Projetos: ${client.name}`;
                        
                        if (client) {
                            manageContactsBtn.classList.remove('hidden');
                            manageContactsBtn.onclick = () => openContactsModal(client.id, client.name);
                        } else {
                            manageContactsBtn.classList.add('hidden');
                        }

                        document.getElementById('back-to-clients-button').classList.remove('hidden');
                    } else {
                        document.getElementById('back-to-clients-button').classList.add('hidden');
                        manageContactsBtn.classList.add('hidden');
                    }
                } else {
                    document.getElementById('back-to-clients-button').classList.add('hidden');
                    manageContactsBtn.classList.add('hidden');
                }

                document.getElementById('project-list-title').textContent = title;

                if (filteredProjects.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1;">Nenhum projeto encontrado.</p>';
                    return;
                }

                filteredProjects.forEach(project => {
                    const latestVersion = project.laborai_project_versions?.[0];
                    const progress = latestVersion?.progress_percentage || 0;
                    
                    let adminActions = '';
                    if (state.isAdmin && !state.isSimulatingClient) {
                        // Safety: escape single quotes in the JSON string because the HTML attribute is wrapped in single quotes.
                        const safeProjectJson = JSON.stringify(project).replace(/'/g, "&apos;");
                        adminActions = `
                            <div class="admin-toolbar" style="margin-top: 15px; border-top: 1px solid var(--border-dark); padding-top: 10px;">
                                <button class="secondary icon-btn" onclick='handleEditProject(${safeProjectJson})'>‚úèÔ∏è Editar</button>
                                <button class="danger icon-btn" onclick="handleDeleteProject('${project.id}')">üóëÔ∏è</button>
                            </div>
                        `;
                    }

                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.innerHTML = `
                        <div onclick="openProjectDetail('${project.id}')">
                            <h4 style="margin: 0 0 5px 0;">${project.name}</h4>
                            <small style="color: var(--text-secondary);">${project.description || 'Sem descri√ß√£o'}</small>
                            <div style="margin: 10px 0;">
                                <div style="display:flex; justify-content:space-between; font-size:0.85em; margin-bottom:4px;">
                                    <span>Progresso</span>
                                    <span>${progress}%</span>
                                </div>
                                <div style="height:6px; background:#374151; border-radius:3px; overflow:hidden;">
                                    <div style="height:100%; width:${progress}%; background: var(${progress > 99 ? '--success-color' : '--primary-accent'});"></div>
                                </div>
                            </div>
                            <small style="color: var(--text-secondary);">Vers√£o Atual: ${latestVersion ? latestVersion.version_number : 'v1.0'}</small>
                        </div>
                        ${adminActions}
                    `;
                    container.appendChild(card);
                });
            }

            // 4. DETALHES DO PROJETO (TIMELINE)
            function renderProjectDetail(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) return;

                state.currentProjectId = projectId;
                document.getElementById('project-detail-name').innerText = project.name;
                
                const versions = project.laborai_project_versions || [];
                versions.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                
                const activeVersion = versions[0];
                state.currentVersionId = activeVersion ? activeVersion.id : null;

                const contentDiv = document.getElementById('project-detail-content');
                contentDiv.innerHTML = '';

                const isAdminMode = state.isAdmin && !state.isSimulatingClient;
                const adminContainerIds = ['progress-control-container', 'add-update-form-container'];
                adminContainerIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (isAdminMode) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                });

                if (isAdminMode && activeVersion) {
                    document.getElementById('progress-slider').value = activeVersion.progress_percentage || 0;
                    document.getElementById('slider-value').innerText = (activeVersion.progress_percentage || 0) + '%';
                    
                    const phaseSelect = document.getElementById('update-phase-select');
                    phaseSelect.innerHTML = '';
                    activeVersion.laborai_project_phases.forEach(ph => {
                        const opt = document.createElement('option');
                        opt.value = ph.id; opt.innerText = ph.name;
                        phaseSelect.appendChild(opt);
                    });
                }

                versions.forEach(version => {
                    const vDiv = document.createElement('div');
                    vDiv.innerHTML = `<h3 style="color: var(--text-secondary); border-bottom: 1px solid var(--border-dark); padding-bottom: 5px; margin-top: 30px;">Vers√£o ${version.version_number}</h3>`;
                    
                    const phases = version.laborai_project_phases.sort((a,b) => a.phase_order - b.phase_order);
                    
                    phases.forEach(phase => {
                        const isCompleted = phase.status === 'completed';
                        const isInProgress = phase.status === 'in_progress';
                        
                        const pHeader = document.createElement('div');
                        pHeader.className = `phase-header ${isInProgress ? 'active' : ''}`;
                        pHeader.style.borderColor = isCompleted ? 'var(--success-color)' : (isInProgress ? 'var(--primary-accent)' : 'var(--border-dark)');
                        
                        let phaseActions = '';
                        if (isAdminMode) {
                            phaseActions = `
                                <div style="display:flex; gap:5px;">
                                    <button class="icon-btn secondary" title="Iniciar" onclick="changePhaseStatus('${phase.id}', 'in_progress')">‚ñ∂Ô∏è</button>
                                    <button class="icon-btn secondary" title="Concluir" onclick="changePhaseStatus('${phase.id}', 'completed')">‚úÖ</button>
                                </div>
                            `;
                        }

                        pHeader.innerHTML = `
                            <div>
                                <h4 style="margin:0;">${phase.name}</h4>
                                <small style="color:${isCompleted ? 'var(--success-color)' : 'var(--text-secondary)'}">
                                    ${phase.status === 'pending' ? 'Pendente' : phase.status === 'in_progress' ? 'Em Andamento' : 'Conclu√≠do'}
                                </small>
                            </div>
                            ${phaseActions}
                        `;
                        vDiv.appendChild(pHeader);

                        const updates = phase.laborai_phase_updates.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                        updates.forEach(upd => {
                            const uDiv = document.createElement('div');
                            uDiv.className = 'update';
                            
                            let content = `<p style="margin-top:5px;">${upd.description || ''}</p>`;
                            if (upd.update_type === 'image' && upd.content_url) {
                                content += `<img src="${upd.content_url.replace('/view', '/uc')}" style="max-width:100%; border-radius:6px; margin-top:10px;">`;
                            } else if (upd.content_url) {
                                content += `<a href="${upd.content_url}" target="_blank" style="color:var(--primary-accent); display:block; margin-top:5px;">üîó Acessar Link</a>`;
                            }

                            let updActions = '';
                            if (isAdminMode) {
                                // Sanitiza√ß√£o para evitar quebra de HTML no onclick
                                // Importante: escapeQuotes para passar no onclick
                                const safeUpd = JSON.stringify(upd).replace(/'/g, "&apos;");
                                
                                updActions = `
                                    <div class="update-actions">
                                        <button class="icon-btn secondary" title="Editar" onclick='handleEditUpdate(${safeUpd})'>‚úèÔ∏è</button>
                                        <button class="icon-btn" style="background:#25D366; color:white;" title="Notificar WhatsApp" onclick="notifyWhatsApp('${upd.id}', '${project.id}')">üì±</button>
                                        <button class="icon-btn danger" title="Excluir" onclick="deleteUpdate('${upd.id}')">üóëÔ∏è</button>
                                    </div>
                                `;
                            }

                            uDiv.innerHTML = `
                                ${updActions}
                                <strong>${upd.title}</strong>
                                <small style="display:block; color:var(--text-secondary);">${new Date(upd.created_at).toLocaleString('pt-BR')}</small>
                                ${content}
                            `;
                            vDiv.appendChild(uDiv);
                        });
                    });
                    contentDiv.appendChild(vDiv);
                });
            }

            // --- FUN√á√ïES DE NAVEGA√á√ÉO E L√ìGICA ---

            window.openClientProjects = (clientId) => {
                state.currentClientId = clientId;
                renderHeader();
                renderProjectList(clientId);
                showView('projectList');
            };

            window.openProjectDetail = (projectId) => {
                renderProjectDetail(projectId);
                showView('projectDetail');
            };

            document.getElementById('client-view-toggle').addEventListener('change', (e) => {
                state.isSimulatingClient = e.target.checked;
                renderHeader();
                if (!document.getElementById('project-detail-view').classList.contains('hidden')) {
                    renderProjectDetail(state.currentProjectId);
                } else if (!document.getElementById('client-list-view').classList.contains('hidden')) {
                    renderClientList();
                } else if (!document.getElementById('project-list-view').classList.contains('hidden')) {
                    renderProjectList(state.currentClientId);
                }
            });

            // --- FUN√á√ïES ADMIN / ACTIONS (Via N8N & Modal Customizado) ---

            // 1. WhatsApp Notification
            window.notifyWhatsApp = async (updateId, projectId) => {
                showGenericModal({
                    title: 'Enviar Notifica√ß√£o',
                    bodyHtml: '<p>Deseja enviar notifica√ß√£o via WhatsApp para todos os contatos deste cliente?</p>',
                    buttons: [{
                        label: 'Enviar',
                        classes: 'primary', // O CSS padr√£o de button j√° √© primary
                        onClick: async () => {
                            await fetch(HOOKS.NOTIFICAR_WHATSAPP, { 
                                method: 'POST', body: JSON.stringify({ updateId, projectId }) 
                            });
                            Toast.success('Notifica√ß√£o enviada!');
                            // Sem necessidade de refresh aqui, a√ß√£o externa
                        }
                    }]
                });
            };

            // 2. Upload Logo
            document.getElementById('upload-logo-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('upload-logo-button');
                const file = document.getElementById('logo-file-input').files[0];
                const clientId = document.getElementById('logo-client-select').value;
                
                btn.innerText = 'Enviando...'; btn.disabled = true;
                
                try {
                    const url = `${HOOKS.ATUALIZAR_LOGO}?clientId=${clientId}&fileName=${encodeURIComponent(file.name)}`;
                    const res = await fetch(url, { method: 'POST', body: file });
                    if(!res.ok) throw new Error();
                    
                    Toast.success('Logo atualizada!');
                    await loadData();
                    if(state.isAdmin) renderClientList();
                } catch(e) { Toast.error('Erro no upload.'); }
                finally { btn.innerText = 'Salvar Logo'; btn.disabled = false; document.getElementById('upload-logo-form').reset(); }
            });

            // 3. Gerenciar Contatos
            window.openContactsModal = async (clientId, clientName) => {
                state.currentManageClientId = clientId;
                document.getElementById('contacts-modal-client-name').innerText = clientName;
                document.getElementById('contacts-modal').classList.remove('hidden');
                
                const listEl = document.getElementById('contacts-list');
                listEl.innerHTML = 'Carregando...';
                
                const { data } = await supabaseClient.from('laborai_client_contacts').select('*').eq('client_id', clientId);
                listEl.innerHTML = '';
                
                if(data) {
                    data.forEach(c => {
                        const item = document.createElement('div');
                        item.className = 'contact-item';
                        item.innerHTML = `
                            <div><strong>${c.name}</strong> (${c.role || '-'})<br><small>${c.whatsapp}</small></div>
                            <button class="danger icon-btn" onclick="deleteContact('${c.id}')">üóëÔ∏è</button>
                        `;
                        listEl.appendChild(item);
                    });
                }
            };

            document.getElementById('add-contact-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('add-contact-btn'); btn.disabled = true;
                try {
                    await fetch(HOOKS.CRIAR_CONTATO, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            clientId: state.currentManageClientId,
                            name: document.getElementById('contact-name').value,
                            role: document.getElementById('contact-role').value,
                            whatsapp: document.getElementById('contact-whatsapp').value
                        })
                    });
                    Toast.success('Contato adicionado!');
                    document.getElementById('add-contact-form').reset();
                    const client = state.clients.find(c => c.id === state.currentManageClientId);
                    openContactsModal(client.id, client.name);
                } catch(e) { Toast.error('Erro ao criar contato'); }
                finally { btn.disabled = false; }
            });

            window.deleteContact = async (id) => {
                showGenericModal({
                    title: 'Excluir Contato',
                    bodyHtml: '<p>Tem certeza que deseja excluir este contato?</p>',
                    buttons: [{
                        label: 'Excluir',
                        classes: 'danger',
                        onClick: async () => {
                            await fetch(HOOKS.EXCLUIR_CONTATO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contactId: id }) });
                            const client = state.clients.find(c => c.id === state.currentManageClientId);
                            openContactsModal(client.id, client.name);
                        }
                    }]
                });
            };

            // 4. CRUD Projeto
            window.handleEditProject = (project) => {
                showGenericModal({
                    title: 'Editar Projeto',
                    bodyHtml: `
                        <label>Nome do projeto:</label>
                        <input type="text" id="edit-project-name" value="${escapeHtml(project.name)}" required style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
                        <label>Descri√ß√£o:</label>
                        <textarea id="edit-project-description" rows="4" placeholder="Adicione uma descri√ß√£o detalhada..." style="width: 100%; box-sizing: border-box;">${escapeHtml(project.description || '')}</textarea>
                    `,
                    buttons: [{
                        label: 'Salvar',
                        classes: 'primary',
                        onClick: async () => {
                            const newName = document.getElementById('edit-project-name').value;
                            const newDescription = document.getElementById('edit-project-description').value;

                            const updates = [
                                { field: 'name', value: newName },
                                { field: 'description', value: newDescription }
                            ];

                            await fetch(HOOKS.EDITAR_PROJETO, { 
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ projectId: project.id, updates }) 
                            });
                            
                            Toast.success('Projeto atualizado');
                            await loadData(); 
                            renderProjectList(state.currentClientId);
                        }
                    }]
                });
            };

            window.handleDeleteProject = async (projectId) => {
                showGenericModal({
                    title: 'Confirmar Exclus√£o',
                    bodyHtml: '<p style="color:var(--error-color);">ATEN√á√ÉO: Isso excluir√° o projeto e todo o hist√≥rico. Esta a√ß√£o n√£o pode ser desfeita.</p>',
                    buttons: [{
                        label: 'Excluir Projeto',
                        classes: 'danger',
                        onClick: async () => {
                            await fetch(HOOKS.EXCLUIR_PROJETO, { 
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ projectId }) 
                            });
                            Toast.success('Projeto exclu√≠do');
                            await loadData(); 
                            renderProjectList(state.currentClientId);
                        }
                    }]
                });
            };

            // 5. CRUD Atualiza√ß√µes (REFATORADO)
            document.getElementById('add-update-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('add-update-button');
                btn.disabled = true; btn.innerText = 'Enviando...';

                const phaseId = document.getElementById('update-phase-select').value;
                const title = document.getElementById('update-title').value;
                const description = document.getElementById('update-description').value;
                const link = document.getElementById('update-link').value;
                const file = document.getElementById('update-file').files[0];

                try {
                    if (file) {
                        // Se tem arquivo, usa o endpoint de upload bin√°rio
                        const url = `${HOOKS.ADD_ATUALIZACAO_ARQUIVO}?phaseId=${phaseId}&title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}&contentUrl=${encodeURIComponent(link)}&fileName=${encodeURIComponent(file.name)}`;
                        await fetch(url, { method: 'POST', body: file });
                    } else {
                        // Se n√£o tem arquivo, usa o endpoint JSON
                        await fetch(HOOKS.ADD_ATUALIZACAO, {
                            method: 'POST', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ phaseId, title, description, contentUrl: link, type: link ? 'link' : 'text' })
                        });
                    }
                    Toast.success('Atualiza√ß√£o adicionada');
                    e.target.reset();
                    await loadData();
                    renderProjectDetail(state.currentProjectId);
                } catch(err) {
                    console.error(err);
                    Toast.error('Erro ao publicar atualiza√ß√£o.');
                } finally {
                    btn.disabled = false; btn.innerText = 'Publicar Atualiza√ß√£o';
                }
            });

            window.handleEditUpdate = async (update) => {
                showGenericModal({
                    title: 'Editar Atualiza√ß√£o',
                    bodyHtml: `
                        <label>T√≠tulo:</label>
                        <input type="text" id="edit-update-title" value="${escapeHtml(update.title)}" required style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
                        <label>Descri√ß√£o:</label>
                        <textarea id="edit-update-desc" rows="4" style="width: 100%; box-sizing: border-box;">${escapeHtml(update.description || '')}</textarea>
                        <label>Link (deixe em branco para remover):</label>
                        <input type="url" id="edit-update-link" value="${update.update_type === 'link' ? escapeHtml(update.content_url) : ''}" placeholder="https://..." style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
                        <label for="edit-update-file" style="font-size: 0.9em; color: var(--text-secondary);">Substituir Imagem (opcional):</label>
                        ${update.update_type === 'image' ? `<img src="${update.content_url.replace('/view', '/uc')}" style="max-width:100px; display:block; margin-bottom:5px;">` : ''}
                        <input type="file" id="edit-update-file" accept="image/*">
                    `,
                    buttons: [{
                        label: 'Salvar Altera√ß√µes',
                        classes: 'primary',
                        onClick: async () => {
                            const newTitle = document.getElementById('edit-update-title').value;
                            const newDesc = document.getElementById('edit-update-desc').value;
                            const newLink = document.getElementById('edit-update-link').value;
                            const newFile = document.getElementById('edit-update-file').files[0];

                            if (newFile) {
                                // L√≥gica para substituir com um novo arquivo (usa o endpoint de upload)
                                const url = `${HOOKS.ADD_ATUALIZACAO_ARQUIVO}?updateIdToOverwrite=${update.id}&title=${encodeURIComponent(newTitle)}&description=${encodeURIComponent(newDesc)}&contentUrl=${encodeURIComponent(newLink)}&fileName=${encodeURIComponent(newFile.name)}`;
                                await fetch(url, { method: 'POST', body: newFile });
                            } else {
                                // L√≥gica para editar apenas os dados textuais
                                await fetch(HOOKS.EDITAR_ATUALIZACAO, {
                                    method: 'POST', headers: {'Content-Type':'application/json'},
                                    body: JSON.stringify({ updateId: update.id, newTitle, newDescription: newDesc, newContentUrl: newLink })
                                });
                            }
                            
                            Toast.success('Atualiza√ß√£o salva!');
                            await loadData();
                            renderProjectDetail(state.currentProjectId);
                        }
                    }]
                });
            };

            window.deleteUpdate = async (updateId) => {
                showGenericModal({
                    title: 'Excluir Atualiza√ß√£o',
                    bodyHtml: '<p>Deseja remover esta atualiza√ß√£o da timeline?</p>',
                    buttons: [{
                        label: 'Excluir',
                        classes: 'danger',
                        onClick: async () => {
                            await fetch(HOOKS.EXCLUIR_ATUALIZACAO, { 
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ updateId }) 
                            });
                            Toast.success('Atualiza√ß√£o removida');
                            await loadData(); 
                            renderProjectDetail(state.currentProjectId);
                        }
                    }]
                });
            };

            // 6. Status da Fase
            window.changePhaseStatus = async (phaseId, status) => {
                await fetch(HOOKS.ATUALIZAR_STATUS_FASE, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ phaseId, newStatus: status })
                });
                Toast.success('Status da fase alterado');
                await loadData(); 
                renderProjectDetail(state.currentProjectId);
            };

            // --- OUTROS FORMUL√ÅRIOS (Refatorados para Auto-Refresh) ---
            
            // Login
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email: document.getElementById('login-email').value, 
                    password: document.getElementById('login-password').value 
                });
                if (error) Toast.error(error.message);
                else initApp(data.user);
            });

            document.getElementById('logout-button').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.reload();
            });

            // Navega√ß√£o Admin Panel
            document.getElementById('admin-panel-button').addEventListener('click', () => {
                populateDropdowns();
                showView('adminForms');
            });
            document.getElementById('back-from-admin-panel').addEventListener('click', () => {
                showView('clientList');
            });

            // Criar Cliente
            document.getElementById('create-client-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-client-name').value;
                await fetch(HOOKS.CRIAR_CLIENTE, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ clientName: name }) });
                Toast.success('Cliente criado'); 
                e.target.reset(); 
                await loadData(); 
                populateDropdowns();
            });

            // Criar Projeto
            document.getElementById('phase-template-select').addEventListener('change', (e) => {
                const isCustom = e.target.value === 'Customizado';
                document.getElementById('new-project-phases').classList.toggle('hidden', !isCustom);
            });
            
            document.getElementById('create-project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const phasesRaw = document.getElementById('new-project-phases').value;
                const template = state.phaseTemplates.find(t => t.name === document.getElementById('phase-template-select').value);
                const phases = template.name === 'Customizado' ? phasesRaw.split('\n') : template.phases;

                await fetch(HOOKS.CRIAR_PROJETO, { 
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ 
                        clientId: document.getElementById('project-client-select').value,
                        projectName: document.getElementById('new-project-name').value,
                        description: document.getElementById('new-project-description').value,
                        phases 
                    })
                });
                Toast.success('Projeto criado'); 
                e.target.reset(); 
                await loadData();
            });

            // Save Progress
            document.getElementById('progress-slider').addEventListener('input', (e) => document.getElementById('slider-value').innerText = e.target.value + '%');
            document.getElementById('save-progress-button').addEventListener('click', async () => {
                const val = document.getElementById('progress-slider').value;
                await fetch(HOOKS.ATUALIZAR_PROGRESSO, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ versionId: state.currentVersionId, newProgress: parseInt(val) })
                });
                Toast.success('Progresso salvo');
                // Nota: O slider √© visual, mas se quiser atualizar a lista de projetos, chame loadData aqui
                await loadData();
            });
            
            // Navega√ß√£o de Voltar
            document.getElementById('back-to-clients-button').addEventListener('click', () => {
                state.currentClientId = null;
                renderHeader();
                showView('clientList');
            });
            document.getElementById('back-to-projects-button').addEventListener('click', () => {
                renderProjectList(state.currentClientId);
                showView('projectList');
            });

            function populateDropdowns() {
                const logoSel = document.getElementById('logo-client-select');
                const projSel = document.getElementById('project-client-select');
                const userSel = document.getElementById('user-client-select');
                [logoSel, projSel, userSel].forEach(s => s.innerHTML = '<option value="">Selecione...</option>');
                
                state.clients.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c.id; opt.innerText = c.name;
                    [logoSel, projSel, userSel].forEach(s => s.appendChild(opt.cloneNode(true)));
                });

                const tmplSel = document.getElementById('phase-template-select');
                tmplSel.innerHTML = '';
                state.phaseTemplates.forEach(t => {
                    const opt = document.createElement('option'); opt.value = t.name; opt.innerText = t.name;
                    tmplSel.appendChild(opt);
                });
            }

            // --- INIT ---
            async function initApp(user) {
                state.user = user;
                state.isAdmin = user.user_metadata.role === 'admin';
                
                await loadData();
                renderHeader();
                showView('app');

                if (state.isAdmin) {
                    renderClientList();
                    showView('clientList');
                } else {
                    renderProjectList(user.user_metadata.clientId);
                    showView('projectList');
                }
            }

            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) initApp(session.user);
                else showView('login');
            });
        });
    </script>
</body>
</html>
