<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Projetos - LaborAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        :root {
            --background-dark: #111827; --surface-dark: #1f2937; --border-dark: #374151;
            --primary-accent: #3b82f6; --primary-accent-hover: #60a5fa; --text-primary: #f9fafb;
            --text-secondary: #9ca3af; --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-dark); color: var(--text-primary); margin: 0; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Login */
        #login-section { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-card { background: var(--surface-dark); padding: 40px; border-radius: 12px; border: 1px solid var(--border-dark); width: 100%; max-width: 400px; text-align: center; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--border-dark); border-radius: 6px; box-sizing: border-box; background-color: #374151; color: var(--text-primary); font-size: 16px; font-family: 'Inter', sans-serif; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; background-color: var(--primary-accent); color: white; font-weight: 500; font-size: 16px; cursor: pointer; transition: background-color 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        button:hover { background-color: var(--primary-accent-hover); }
        button:disabled { background-color: #4b5563; cursor: not-allowed; }
        
        /* Button Variants */
        button.secondary { background: transparent; border: 1px solid var(--border-dark); color: var(--text-primary); }
        button.secondary:hover { background: var(--border-dark); }
        button.danger { background-color: rgba(239, 68, 68, 0.2); color: var(--error-color); border: 1px solid var(--error-color); }
        button.danger:hover { background-color: rgba(239, 68, 68, 0.3); }
        button.icon-btn { width: auto; padding: 6px 12px; font-size: 14px; }
        
        /* Header */
        #app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border-dark); margin-bottom: 24px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .client-logo-header-img { height: 32px; object-fit: contain; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-right: 20px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .project-card, .client-card { background: var(--surface-dark); padding: 20px; border-radius: 8px; border: 1px solid var(--border-dark); cursor: pointer; transition: transform 0.2s, border-color 0.2s; position: relative; }
        .project-card:hover, .client-card:hover { transform: translateY(-3px); border-color: var(--primary-accent); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .client-logo-thumb { height: 40px; max-width: 100px; object-fit: contain; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 4px; }
        
        /* Timeline/Details - Accordion Styles */
        .phase-header { border: 2px solid var(--border-dark); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--surface-dark); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .phase-header.active { border-color: var(--primary-accent); animation: pulse-border 3s infinite; }
        .phase-header::after { content: '‚ñº'; margin-left: 10px; transition: transform 0.3s; font-size: 0.8em; }
        .phase-header.expanded::after { transform: rotate(180deg); }
        
        .phase-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .phase-header.expanded + .phase-content { max-height: 2000px; transition: max-height 0.5s ease-in; }

        /* Phase Actions Hover Effect */
        .phase-header .phase-actions { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .phase-header:hover .phase-actions { opacity: 1; }

        .update { margin-left: 20px; margin-bottom: 12px; padding: 15px; background: var(--background-dark); border-left: 3px solid var(--border-dark); border-radius: 0 8px 8px 0; position: relative; }
        .update-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; opacity: 0.7; }
        .update-actions:hover { opacity: 1; }
        .update img {
            max-height: 300px; /* Limita a altura da imagem na timeline */
            width: auto;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .update img:hover {
            opacity: 0.8;
        }

        /* LIGHTBOX CSS AJUSTADO */
        #lightbox-img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* Admin Sections */
        .admin-section-card { border: 1px solid var(--border-dark); border-radius: 8px; padding: 20px; margin-top: 20px; background: var(--surface-dark); }
        .admin-toolbar { display: flex; gap: 8px; margin-top: 10px; }
        
        /* Toast */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.75rem; max-width: 420px; }
        .toast { padding: 1rem 1.25rem; border-radius: 8px; background-color: var(--surface-dark); border-left: 4px solid; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
        .toast.success { border-color: var(--success-color); } .toast.error { border-color: var(--error-color); } .toast.info { border-color: var(--primary-accent); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* Modals */
        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface-dark); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; border: 1px solid var(--border-dark); max-height: 90vh; overflow-y: auto; }
        
        /* Contacts List in Modal */
        .contact-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-dark); }
        .contact-item:last-child { border-bottom: none; }
        
        /* Automation Reports Table */
        #automation-history-table th, #automation-history-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-dark);
            text-align: left;
        }
        #automation-history-table tbody tr:nth-child(even) {
            background-color: var(--background-dark);
        }
        #automation-history-table tbody tr:hover {
            background-color: #374151;
        }
        .kpi-card {
            background: var(--background-dark);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-dark);
        }
        .kpi-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-accent);
        }
        .kpi-card .label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 4px;
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- TELA DE LOGIN -->
    <div id="login-section">
        <div class="login-card">
            <h2>Portal LaborAI</h2>
            <p>Acesse para gerenciar seus projetos.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" placeholder="Sua senha" required>
                <button type="submit">Entrar</button>
            </form>
        </div>
    </div>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div id="app-container" class="container hidden">
        <header id="app-header">
            <div class="header-left">
                <!-- Logo do Cliente (Carregada Dinamicamente) -->
                <img id="header-client-logo" class="client-logo-header-img hidden" alt="Logo">
                <div>
                    <strong style="font-size: 1.2rem;">LaborAI</strong>
                    <span id="header-client-name" style="color: var(--text-secondary); margin-left: 8px;"></span>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                
                <!-- Toggle "Ver como Cliente" (Apenas Admin) -->
                <div id="admin-simulation-toggle" class="toggle-container hidden">
                    <span style="font-size: 0.9em; color: var(--text-secondary);">Ver como Cliente</span>
                    <label class="switch">
                        <input type="checkbox" id="client-view-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <span id="user-email" style="font-size: 0.9em; margin-right: 16px; color: var(--text-secondary);"></span>
                
                <!-- Bot√£o Painel Admin (Apenas Admin) -->
                <button id="admin-panel-button" class="hidden secondary" style="width: auto; padding: 6px 12px; margin-right: 10px;">
                    ‚öôÔ∏è Painel & Cria√ß√£o
                </button>
                
                <button id="logout-button" class="secondary" style="width: auto; padding: 6px 12px;">Sair</button>
            </div>
        </header>

        <main id="main-content">
            <!-- VIEW 1: Lista de Clientes (Home do Admin) -->
            <div id="client-list-view" class="hidden">
                <h3>Meus Clientes</h3>
                <div id="clients-list" class="card-grid"></div>
            </div>

            <!-- VIEW 2: Lista de Projetos (Home do Cliente / Navega√ß√£o Admin) -->
            <div id="project-list-view" class="hidden">
                <button id="back-to-clients-button" class="secondary hidden" style="margin-bottom: 20px;">&larr; Voltar para Clientes</button>
                <!-- Adicionar logo ap√≥s o bot√£o de voltar -->
                <h2 style="font-weight: 500; border-bottom: 1px solid var(--border-dark); padding-bottom: 16px; margin-bottom: 24px;">Projetos</h2>
                <div id="project-list-content" class="card-grid"></div>
            </div>

            <!-- VIEW 3: Detalhes do Projeto (Timeline) -->
            <div id="project-detail-view" class="hidden">
                <button id="back-to-projects-button" class="secondary" style="margin-bottom: 20px;">&larr; Voltar para Projetos</button>
                
                <!-- Cabe√ßalho do Projeto Refatorado -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 id="project-detail-name" style="margin: 0;">Nome do Projeto</h2>
                    <button id="toggle-add-update-form" class="primary icon-btn hidden">[+] Nova Atualiza√ß√£o</button>
                </div>

                <!-- Container de Abas -->
                <div class="tab-container hidden" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-dark); padding-bottom: 10px;">
                    <button id="btn-view-timeline" class="secondary icon-btn" style="background: var(--primary-accent);">üïí Linha do Tempo</button>
                    <button id="btn-view-reports" class="secondary icon-btn">üìä Relat√≥rios de Uso</button>
                </div>

                <!-- Conte√∫do da Linha do Tempo -->
                <div id="project-timeline-content">
                    <div id="project-description-container" class="admin-section-card" style="margin-bottom: 24px; padding: 20px;">
                        <h3 style="margin-top: 0; margin-bottom: 10px;">Sobre o Projeto</h3>
                        <p id="project-detail-description" style="color: var(--text-secondary); margin: 0; white-space: pre-wrap;"></p>
                    </div>

                    <div id="progress-view-container" class="admin-section-card" style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0;">üìä Progresso</h3>
                            <span id="progress-percentage-display" style="font-weight: bold; font-size: 1.1rem;">0%</span>
                        </div>
                        <div style="height: 8px; background-color: var(--border-dark); border-radius: 4px; overflow: hidden;">
                            <div id="progress-bar-fill" style="width: 0%; height: 100%; background-color: var(--primary-accent); transition: width 0.3s;"></div>
                        </div>
                        <div id="admin-progress-controls" class="hidden" style="margin-top: 15px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="range" min="0" max="100" value="0" id="progress-slider" style="flex: 1;">
                                <button id="save-progress-button" style="width: auto;">Salvar</button>
                            </div>
                        </div>
                    </div>

                    <div id="project-detail-content" style="margin-top: 24px;"></div>

                    <div id="add-update-form-container" class="hidden">
                        <form id="add-update-form">
                            <select id="update-phase-select" required></select>
                            <input type="text" id="update-title" placeholder="T√≠tulo da atualiza√ß√£o" required>
                            <textarea id="update-description" rows="3" placeholder="Descri√ß√£o detalhada... (Obrigat√≥rio)"></textarea>
                            <input type="url" id="update-link" placeholder="Anexar Link (Opcional, ex: https://...)">
                            <label for="update-file" style="font-size: 0.9em; color: var(--text-secondary);">Anexar Arquivo (Opcional):</label>
                            <input type="file" id="update-file">
                            <button type="submit" id="add-update-button" style="margin-top:15px;">Publicar Atualiza√ß√£o</button>
                        </form>
                    </div>
                </div>

                <!-- Conte√∫do dos Relat√≥rios -->
                <div id="project-reports-content" class="hidden">
                    <div id="reports-dashboard">
                        <div id="kpi-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
                        <div id="usage-chart" style="background: var(--surface-dark); border: 1px solid var(--border-dark); border-radius: 8px; padding: 15px; margin-bottom: 20px; min-height: 300px;"></div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 0.9em; color: var(--text-secondary);">Mostrar:</span>
                                <select id="rows-per-page" style="width: auto; margin-bottom: 0; padding: 5px;">
                                    <option value="15">15</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="pagination-controls" style="display: flex; gap: 5px;"></div>
                        </div>

                        <input type="text" id="report-search" placeholder="Pesquisar por produto..." style="margin-bottom: 10px;">
                        <div style="overflow-x: auto;">
                            <table id="automation-history-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="text-align: left; border-bottom: 2px solid var(--border-dark);">
                                        <th style="padding: 10px;">Data</th>
                                        <th>Bitola</th>
                                        <th>Produto</th>
                                        <th>Qtd</th>
                                        <th>Barra</th>
                                        <th>% Perda</th>
                                    </tr>
                                </thead>
                                <tbody id="automation-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <!-- VIEW 4: Painel Administrativo (Formul√°rios de Cria√ß√£o) -->
            <div id="admin-forms-view" class="hidden">
                <button id="back-from-admin-panel" class="secondary" style="margin-bottom: 20px;">&larr; Voltar</button>
                <h2>Painel de Gest√£o & Cria√ß√£o</h2>
                
                <div class="card-grid">
                    <!-- Upload de Logo -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üñºÔ∏è Logo do Cliente</h3>
                        <form id="upload-logo-form">
                            <label>Cliente:</label>
                            <select id="logo-client-select" required></select>
                            <label>Arquivo (PNG/JPG/SVG):</label>
                            <input type="file" id="logo-file-input" accept="image/png, image/jpeg, image/svg+xml" required>
                            <button type="submit" id="upload-logo-button">Salvar Logo</button>
                        </form>
                    </div>

                    <!-- Criar Cliente -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üè¢ Novo Cliente</h3>
                        <form id="create-client-form">
                            <label>Nome da Empresa:</label>
                            <input type="text" id="new-client-name" placeholder="Ex: Molas Fama" required>
                            <button type="submit" id="create-client-button">Criar Cliente</button>
                        </form>
                    </div>

                    <!-- Criar Usu√°rio -->
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üë§ Novo Usu√°rio</h3>
                        <form id="create-user-form">
                            <label>Associar ao Cliente:</label>
                            <select id="user-client-select" required></select>
                            <label>E-mail:</label>
                            <input type="email" id="new-user-email" required>
                            <label>Senha Provis√≥ria:</label>
                            <input type="password" id="new-user-password" required>
                            <button type="submit" id="create-user-button">Criar Usu√°rio</button>
                        </form>
                    </div>
                </div>

                <!-- Criar Projeto -->
                <div class="admin-section-card">
                    <h3>üöÄ Novo Projeto</h3>
                    <form id="create-project-form">
                        <label>Cliente:</label>
                        <select id="project-client-select" required></select>
                        <label>Nome do Projeto:</label>
                        <input type="text" id="new-project-name" required>
                        <label>Descri√ß√£o:</label>
                        <textarea id="new-project-description" rows="2"></textarea>
                        <label>Template de Fases:</label>
                        <select id="phase-template-select" required></select>
                        <textarea id="new-project-phases" rows="4" class="hidden" placeholder="Fase 1..."></textarea>
                        <button type="submit" id="create-project-button">Criar Projeto</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: Nova Vers√£o -->
    <div id="new-version-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Iniciar Nova Vers√£o</h3>
            <form id="new-version-form">
                <input type="text" id="new-version-number" placeholder="Ex: V2.0" required>
                <textarea id="new-version-summary" rows="3" placeholder="Resumo das mudan√ßas..." required></textarea>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="secondary" onclick="document.getElementById('new-version-modal').classList.add('hidden')">Cancelar</button>
                    <button type="submit">Criar Vers√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Gerenciar Contatos -->
    <div id="contacts-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Gerenciar Contatos</h3>
            <p id="contacts-modal-client-name" style="color: var(--text-secondary); margin-bottom: 15px;"></p>
            
            <!-- Lista -->
            <div id="contacts-list" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-dark); border-radius: 6px;">
                <!-- Itens inseridos via JS -->
            </div>

            <!-- Adicionar Novo -->
            <h4 style="border-top: 1px solid var(--border-dark); padding-top: 15px;">Adicionar Novo</h4>
            <form id="add-contact-form">
                <input type="text" id="contact-name" placeholder="Nome" required style="margin-bottom: 8px;">
                <input type="text" id="contact-role" placeholder="Cargo" style="margin-bottom: 8px;">
                <input type="text" id="contact-whatsapp" placeholder="WhatsApp (55119...)" required style="margin-bottom: 8px;">
                <button type="submit" id="add-contact-btn">Adicionar Contato</button>
            </form>
            <button class="secondary" onclick="document.getElementById('contacts-modal').classList.add('hidden')" style="margin-top: 15px; width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- MODAL GEN√âRICO PARA A√á√ïES -->
    <div id="generic-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="modal-title">T√≠tulo Padr√£o</h3>
            <div id="modal-body" style="margin: 20px 0;">
                <!-- Conte√∫do ser√° injetado aqui via JS -->
            </div>
            <div id="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <!-- Bot√µes ser√£o injetados aqui via JS -->
            </div>
        </div>
    </div>

    <!-- LIGHTBOX PARA IMAGENS -->
    <div id="image-lightbox" class="modal hidden">
        <div class="modal-content" style="max-width: 90%; max-height: 90%; display: flex; gap: 20px; padding: 20px;">
            <div style="flex: 2; display: flex; justify-content: center; align-items: center; position: relative;">
                <img id="lightbox-img" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                <a id="lightbox-download-link" href="#" download class="icon-btn" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5);">üì• Download</a>
            </div>
            <div id="lightbox-info-panel" style="flex: 1; border-left: 1px solid var(--border-dark); padding-left: 20px; overflow-y: auto;">
                <h3 id="lightbox-update-title" style="margin-top: 0;"></h3>
                <small id="lightbox-update-date" style="color: var(--text-secondary); display: block; margin-bottom: 15px;"></small>
                <p id="lightbox-update-description"></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURA√á√ÉO ---
            const SUPABASE_URL = 'https://vzmhnponxmrvoqctmpty.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6bWhucG9ueG1ydm9xY3RtcHR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3Mzg5MjYsImV4cCI6MjA3MDMxNDkyNn0.sSfMCpPKwFp2lVLuWnFN066OT0lluMb-sd-kWb1PePg';
            
            // Webhooks do N8N
            const N8N_BASE = 'https://n8n-n8n.znxk1t.easypanel.host/webhook';
            const HOOKS = {
                // Uploads e Cria√ß√£o
                ATUALIZAR_LOGO: `${N8N_BASE}/atualizar-logo-cliente`,
                CRIAR_CLIENTE: `${N8N_BASE}/criar-novo-cliente`,
                CRIAR_USUARIO: `${N8N_BASE}/criar-novo-usuario`,
                CRIAR_PROJETO: `${N8N_BASE}/criar-novo-projeto`,
                SALVAR_ATUALIZACAO: `${N8N_BASE}/salvar-atualizacao`,
                
                // Gest√£o de Projeto
                ATUALIZAR_PROGRESSO: `${N8N_BASE}/atualizar-progresso-projeto`,
                ATUALIZAR_STATUS_FASE: `${N8N_BASE}/atualizar-status-fase`,
                CRIAR_NOVA_VERSAO: `${N8N_BASE}/criar-nova-vers√£o`,
                NOTIFICAR_WHATSAPP: `${N8N_BASE}/notificar-whatsapp`,
                
                // CRUD e Gest√£o
                CRIAR_CONTATO: `${N8N_BASE}/criar-contato-cliente`,
                EXCLUIR_CONTATO: `${N8N_BASE}/excluir-contato-cliente`,
                EDITAR_PROJETO: `${N8N_BASE}/editar-projeto`, 
                EXCLUIR_PROJETO: `${N8N_BASE}/excluir-projeto`, 
                EXCLUIR_ATUALIZACAO: `${N8N_BASE}/excluir-atualizacao`
            };

            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- ESTADO GLOBAL ---
            let state = {
                user: null,
                isAdmin: false,
                isSimulatingClient: false,
                clients: [],
                projects: [],
                contacts: [],
                currentClientId: null,
                currentProjectId: null,
                currentVersionId: null,
                phaseTemplates: [
                    { name: "Padr√£o (3 Fases)", phases: ["Levantamento", "Desenvolvimento", "Valida√ß√£o"] },
                    { name: "Completo (5 Fases)", phases: ["Diagn√≥stico", "Design", "Dev", "Homologa√ß√£o", "Go-Live"] },
                    { name: "Customizado", phases: [] }
                ]
            };

            // --- UTILS ---
            const Toast = {
                container: document.getElementById('toast-container'),
                show(type, msg) {
                    const el = document.createElement('div'); el.className = `toast ${type}`;
                    el.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${msg}</span>`;
                    this.container.appendChild(el);
                    setTimeout(() => el.remove(), 4000);
                },
                success(m) { this.show('success', m); }, error(m) { this.show('error', m); }, info(m) { this.show('info', m); }
            };

            // Fun√ß√£o de escape para strings em HTML
            function escapeHtml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                    .replace(/`/g, "&#96;"); // Importante para template literals
            }
            
            // --- AJUSTE 1: getGoogleDriveDirectImage CORRIGIDA ---
            function getGoogleDriveDirectImage(url) {
                if (!url || typeof url !== 'string' || url === 'null' || url === 'undefined') return null;
                
                let match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}`;
                
                match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}`;
                
                return null;
            }

            // Sistema de Modal Gen√©rico
            window.showGenericModal = function({ title, bodyHtml, buttons }) {
                const modal = document.getElementById('generic-modal');
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = bodyHtml;

                const footer = document.getElementById('modal-footer');
                footer.innerHTML = ''; // Limpa bot√µes antigos

                // Bot√£o para fechar o modal
                const closeModal = () => modal.classList.add('hidden');

                // Adiciona um bot√£o de "Cancelar" padr√£o (se houver bot√µes customizados ou se n√£o houver nenhum)
                if (buttons.length > 0 || buttons.length === 0) {
                    const cancelButton = document.createElement('button');
                    cancelButton.className = 'secondary';
                    cancelButton.innerText = 'Cancelar';
                    cancelButton.onclick = closeModal;
                    footer.appendChild(cancelButton);
                }

                // Adiciona bot√µes customizados
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.innerText = btnConfig.label;
                    if (btnConfig.classes) button.className = btnConfig.classes;
                    
                    button.onclick = async () => {
                        const originalText = button.innerText;
                        button.disabled = true;
                        button.innerText = '...';
                        try {
                            await btnConfig.onClick();
                            closeModal();
                        } catch (e) {
                            console.error(e);
                            Toast.error("Erro na a√ß√£o");
                        } finally {
                            button.disabled = false;
                            button.innerText = originalText;
                        }
                    };
                    footer.appendChild(button);
                });

                modal.classList.remove('hidden');
            };

            // --- AJUSTE LIGHTBOX GLOBAL ---
            window.openImageLightbox = function(update) {
                const lightbox = document.getElementById('image-lightbox');
                const img = document.getElementById('lightbox-img');
                const downloadLink = document.getElementById('lightbox-download-link');
                
                const directImageUrl = getGoogleDriveDirectImage(update.content_url);
                if (!directImageUrl) {
                    Toast.error("N√£o foi poss√≠vel carregar a imagem original.");
                    return;
                }

                // Define a imagem principal
                img.src = directImageUrl;
                
                // Configura o link de download (for√ßando o download do Google Drive)
                downloadLink.href = update.content_url.replace(/(&?)(export=download|usp=drivesdk|view)$/, '') + '&export=download';
                
                // Popula o painel de informa√ß√µes lateral
                document.getElementById('lightbox-update-title').innerText = update.title || "Atualiza√ß√£o";
                document.getElementById('lightbox-update-date').innerText = new Date(update.created_at).toLocaleString('pt-BR');
                document.getElementById('lightbox-update-description').innerText = update.description || 'Sem descri√ß√£o adicional.';
                
                // Exibe o modal
                lightbox.classList.remove('hidden');
            };

            const Views = {
                login: document.getElementById('login-section'),
                app: document.getElementById('app-container'),
                clientList: document.getElementById('client-list-view'),
                projectList: document.getElementById('project-list-view'),
                projectDetail: document.getElementById('project-detail-view'),
                adminForms: document.getElementById('admin-forms-view')
            };

            function showView(viewName) {
                Object.values(Views).forEach(el => { if(el && el !== Views.app) el.classList.add('hidden'); });
                if (viewName !== 'login') Views.app.classList.remove('hidden');
                if (Views[viewName]) Views[viewName].classList.remove('hidden');
            }

            // --- DATA FETCHING (LEITURA via Supabase, ESCRITA via Webhook) ---
            async function loadData() {
                try {
                    // 1. Carregar Projetos
                    let query = supabaseClient.from('laborai_projects').select(`*, laborai_clients(name, logo_url), laborai_project_versions(*, laborai_project_phases(*, laborai_phase_updates(*)))`).order('created_at', { ascending: false });
                    
                    if (!state.isAdmin) {
                        const clientId = state.user.user_metadata.clientId;
                        if (clientId) query = query.eq('client_id', clientId);
                    }
                    
                    const { data: projData, error: projError } = await query;
                    if (projError) throw projError;
                    state.projects = projData;

                    // 2. Carregar Clientes (Apenas Admin)
                    if (state.isAdmin) {
                        const { data: clientData, error: clientError } = await supabaseClient.from('laborai_clients').select('*').order('name');
                        if (clientError) throw clientError;
                        state.clients = clientData;
                    }
                } catch (e) {
                    console.error(e);
                    Toast.error('Erro ao carregar dados: ' + e.message);
                }
            }

            // --- RENDERIZA√á√ÉO ---

            // 1. HEADER
            function renderHeader() {
                document.getElementById('user-email').textContent = state.user.email;
                const adminPanelBtn = document.getElementById('admin-panel-button');
                const toggleContainer = document.getElementById('admin-simulation-toggle');
                
                if (state.isAdmin) {
                    toggleContainer.classList.remove('hidden');
                    // Refatora√ß√£o da Tarefa 3: S√≥ mostra painel se estiver dentro de um cliente
                    adminPanelBtn.classList.toggle('hidden', !state.currentClientId);
                } else {
                    adminPanelBtn.classList.add('hidden');
                    toggleContainer.classList.add('hidden');
                }

                // --- L√ìGICA DE EXIBI√á√ÉO DO LOGO DO CLIENTE ---
                const headerLogoImg = document.getElementById('header-client-logo');
                const headerClientNameSpan = document.getElementById('header-client-name');
                let clientForHeader = null;

                const clientIdToShow = state.isAdmin ? state.currentClientId : state.user.user_metadata.clientId;

                if (clientIdToShow && state.clients.length > 0) {
                    clientForHeader = state.clients.find(c => c.id === clientIdToShow);
                } else if (clientIdToShow && state.projects.length > 0) {
                    const projectFromClient = state.projects.find(p => p.client_id === clientIdToShow);
                    if (projectFromClient && projectFromClient.laborai_clients) {
                        clientForHeader = projectFromClient.laborai_clients;
                    }
                }

                if (clientForHeader && clientForHeader.logo_url) {
                    headerLogoImg.src = clientForHeader.logo_url.replace('/view', '/uc');
                    headerLogoImg.classList.remove('hidden');
                    headerClientNameSpan.textContent = `| ${clientForHeader.name}`;
                } else if (clientForHeader) {
                    headerLogoImg.classList.add('hidden');
                    headerClientNameSpan.textContent = `| ${clientForHeader.name}`;
                } else {
                    headerLogoImg.classList.add('hidden');
                    headerClientNameSpan.textContent = state.isAdmin ? (state.isSimulatingClient ? " (Modo Visualiza√ß√£o)" : " | Admin") : "";
                }
            }

            // 2. LISTA DE CLIENTES
            function renderClientList() {
                const container = document.getElementById('clients-list');
                container.innerHTML = '';
                
                state.clients.forEach(client => {
                    const card = document.createElement('div');
                    card.className = 'client-card';
                    card.onclick = (e) => {
                        if (e.target.tagName === 'BUTTON') return;
                        openClientProjects(client.id);
                    };

                    const logoHtml = client.logo_url 
                        ? `<img src="${client.logo_url.replace('/view', '/uc')}" class="client-logo-thumb">`
                        : `<div style="width:40px; height:40px; background:#374151; border-radius:4px; display:flex; align-items:center; justify-content:center; font-weight:bold;">${client.name.substring(0,2).toUpperCase()}</div>`;

                    card.innerHTML = `
                        <div class="card-header">
                            <div>
                                <h4 style="margin:0;">${client.name}</h4>
                                <small style="color:var(--text-secondary)">ID: ${client.id.split('-')[0]}...</small>
                            </div>
                            ${logoHtml}
                        </div>
                        <div style="margin-top: 15px; border-top: 1px solid var(--border-dark); padding-top: 10px;">
                            <button class="secondary" style="width: 100%;" onclick="openClientProjects('${client.id}')">üìÇ Ver Projetos &rarr;</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // 3. LISTA DE PROJETOS
            function renderProjectList(clientId = null) {
                const container = document.getElementById('project-list-content');
                container.innerHTML = '';
                
                let filteredProjects = state.projects;
                
                if (state.isAdmin) {
                    if (clientId) {
                        filteredProjects = state.projects.filter(p => p.client_id === clientId);
                        document.getElementById('back-to-clients-button').classList.remove('hidden');
                    } else {
                        document.getElementById('back-to-clients-button').classList.add('hidden');
                    }
                } else {
                    document.getElementById('back-to-clients-button').classList.add('hidden');
                }

                if (filteredProjects.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1;">Nenhum projeto encontrado.</p>';
                    return;
                }

                filteredProjects.forEach(project => {
                    const latestVersion = project.laborai_project_versions?.[0];
                    const progress = latestVersion?.progress_percentage || 0;
                    
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.onclick = () => openProjectDetail(project.id); // O card inteiro agora √© o link

                    const description = project.description || 'Sem descri√ß√£o';
                    const shortDesc = description.length > 120 ? description.substring(0, 120) + '...' : description;

                    let adminActions = '';
                    if (state.isAdmin && !state.isSimulatingClient) {
                        adminActions = `
                            <div class="admin-toolbar" style="margin-top: 15px; border-top: 1px solid var(--border-dark); padding-top: 10px;">
                                <button class="secondary icon-btn" onclick="event.stopPropagation(); handleEditProject(${JSON.stringify(project)})">‚úèÔ∏è Editar</button>
                                <button class="danger icon-btn" onclick="event.stopPropagation(); handleDeleteProject('${project.id}')">üóëÔ∏è</button>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <div>
                            <h4 style="margin: 0 0 5px 0;">${project.name}</h4>
                            <small style="color: var(--text-secondary);">${shortDesc}</small>
                            <div style="margin: 10px 0;">
                                <div style="display:flex; justify-content:space-between; font-size:0.85em; margin-bottom:4px;">
                                    <span>Progresso</span>
                                    <span>${progress}%</span>
                                </div>
                                <div style="height:6px; background:#374151; border-radius:3px; overflow:hidden;">
                                    <div style="height:100%; width:${progress}%; background: var(${progress > 99 ? '--success-color' : '--primary-accent'});"></div>
                                </div>
                            </div>
                            <small style="color: var(--text-secondary);">Vers√£o Atual: ${latestVersion ? latestVersion.version_number : 'v1.0'}</small>
                        </div>
                        ${adminActions}
                    `;
                    container.appendChild(card);
                });
            }
            
            // State for reports view
            let allAutomationLogs = [];
            let currentPage = 1;
            let rowsPerPage = 15;

            function renderChart(logs) {
                const chartEl = document.querySelector("#usage-chart");
                chartEl.innerHTML = ''; 

                const sortedLogs = [...logs].reverse();

                const dailyData = {};
                sortedLogs.forEach(log => {
                    const date = new Date(log.created_at).toLocaleDateString('pt-BR');
                    dailyData[date] = (dailyData[date] || 0) + 1;
                });

                const options = {
                    chart: { type: 'area', height: 300, toolbar: {show: false}, foreColor: '#9ca3af', background: 'transparent', zoom: { enabled: false } },
                    dataLabels: { enabled: false },
                    series: [{ name: 'Otimiza√ß√µes', data: Object.values(dailyData) }],
                    xaxis: { categories: Object.keys(dailyData) },
                    stroke: { curve: 'smooth', width: 2, colors: ['#3b82f6'] },
                    fill: { type: 'gradient', colors: ['#3b82f6'], gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 100] } },
                    grid: { borderColor: '#374151', strokeDashArray: 4 },
                    tooltip: { theme: 'dark' },
                    theme: { mode: 'dark' }
                };
                new ApexCharts(chartEl, options).render();
            }

            function renderPaginationControls() {
                const controlsContainer = document.getElementById('pagination-controls');
                controlsContainer.innerHTML = '';
                const pageCount = Math.ceil(allAutomationLogs.length / rowsPerPage);

                if (pageCount <= 1) return;

                const prevButton = document.createElement('button');
                prevButton.innerText = '‚Üê';
                prevButton.className = 'secondary icon-btn';
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayPaginatedTable();
                    }
                };
                controlsContainer.appendChild(prevButton);

                const pageInfo = document.createElement('span');
                pageInfo.innerText = `P√°g ${currentPage} de ${pageCount}`;
                pageInfo.style.cssText = 'font-size: 0.9em; color: var(--text-secondary); padding: 0 8px;';
                controlsContainer.appendChild(pageInfo);

                const nextButton = document.createElement('button');
                nextButton.innerText = '‚Üí';
                nextButton.className = 'secondary icon-btn';
                nextButton.disabled = currentPage === pageCount;
                nextButton.onclick = () => {
                    if (currentPage < pageCount) {
                        currentPage++;
                        displayPaginatedTable();
                    }
                };
                controlsContainer.appendChild(nextButton);
            }

            function displayPaginatedTable() {
                const tableBody = document.getElementById('automation-history-body');
                tableBody.innerHTML = '';
                
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const paginatedItems = allAutomationLogs.slice(start, end);

                paginatedItems.forEach(log => {
                     let s = log.summary_data;
                    if (typeof s === 'string') { try { s = JSON.parse(s); } catch (e) { console.error("Error parsing summary_data:", e); s = {}; } }
                    s = s || {};

                    const bitola = s.bitola || "-";
                    const produto = s.produto || "-";
                    const qtd = parseInt(s.qtd || 0);
                    const barra = s.barra || 0;
                    const perda = parseFloat(s.perda || 0);

                    const row = document.createElement('tr');
                    row.dataset.productName = produto.toLowerCase();
                    row.innerHTML = `
                        <td style="color: var(--text-secondary); font-size: 0.85em;">${new Date(log.created_at).toLocaleDateString('pt-BR')}</td>
                        <td style="color: var(--primary-accent); font-weight: bold;">${bitola}</td>
                        <td>${produto}</td>
                        <td style="text-align: center;">${qtd}</td>
                        <td style="text-align: center;">${barra}mm</td>
                        <td style="font-weight: bold; color: ${perda > 3 ? 'var(--error-color)' : (perda > 1 ? 'var(--warning-color)' : 'var(--success-color)')}">
                            ${perda.toFixed(2)}%
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                renderPaginationControls();
            }


            async function renderAutomationReports(projectId) {
                const tableBody = document.getElementById('automation-history-body');
                const kpiContainer = document.getElementById('kpi-cards');
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Carregando dados...</td></tr>';
                kpiContainer.innerHTML = '';
                document.getElementById('pagination-controls').innerHTML = '';
                document.getElementById('usage-chart').innerHTML = '';

                try {
                    const { data, error } = await supabaseClient.from('laborai_automation_logs').select('*').eq('project_id', projectId).order('created_at', { ascending: false });
                    if (error) throw error;
                    
                    allAutomationLogs = data || [];
                    currentPage = 1;
                    rowsPerPage = parseInt(document.getElementById('rows-per-page').value, 10);
                    
                    if (allAutomationLogs.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhum registro de automa√ß√£o encontrado.</td></tr>';
                        return;
                    }

                    // KPIs
                    let totalCortes = 0;
                    let totalPerdaValue = 0;
                    allAutomationLogs.forEach(log => {
                        let s = log.summary_data;
                        if (typeof s === 'string') { try { s = JSON.parse(s); } catch (e) { s = {}; } }
                        s = s || {};
                        totalCortes += parseInt(s.qtd || 0);
                        totalPerdaValue += parseFloat(s.perda || 0);
                    });
                    const avgPerda = allAutomationLogs.length > 0 ? (totalPerdaValue / allAutomationLogs.length) : 0;
                    kpiContainer.innerHTML = `
                        <div class="kpi-card"><div class="value">${allAutomationLogs.length}</div><div class="label">Total de C√°lculos</div></div>
                        <div class="kpi-card"><div class="value">${totalCortes}</div><div class="label">Pe√ßas Cortadas</div></div>
                        <div class="kpi-card"><div class="value">${avgPerda.toFixed(2)}%</div><div class="label">M√©dia de Perda</div></div>
                    `;

                    renderChart(allAutomationLogs);
                    displayPaginatedTable();

                    document.getElementById('rows-per-page').onchange = (e) => {
                        rowsPerPage = parseInt(e.target.value, 10);
                        currentPage = 1;
                        displayPaginatedTable();
                    };

                } catch (e) {
                    console.error("Erro ao buscar logs:", e);
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Este projeto ainda n√£o possui dados de automa√ß√£o registrados.</td></tr>';
                }
            }


            // 4. DETALHES DO PROJETO (TIMELINE)
            function renderProjectDetail(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) return;

                document.getElementById('project-detail-description').innerText = project.description || 'Nenhuma descri√ß√£o fornecida.';
                state.currentProjectId = projectId;
                document.getElementById('project-detail-name').innerText = project.name;
                
                const versions = project.laborai_project_versions || [];
                versions.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                
                const contentDiv = document.getElementById('project-detail-content');
                contentDiv.innerHTML = '';

                const activeVersion = versions[0];
                state.currentVersionId = activeVersion ? activeVersion.id : null;
                const progress = activeVersion?.progress_percentage || 0;

                document.getElementById('progress-percentage-display').innerText = `${progress}%`;
                const progressBarFill = document.getElementById('progress-bar-fill');
                progressBarFill.style.width = `${progress}%`;
                progressBarFill.style.backgroundColor = progress >= 100 ? 'var(--success-color)' : 'var(--primary-accent)';

                const isAdminMode = state.isAdmin && !state.isSimulatingClient;
                document.getElementById('admin-progress-controls').classList.toggle('hidden', !isAdminMode);

                if (isAdminMode && activeVersion) {
                    document.getElementById('progress-slider').value = progress;
                    const phaseSelect = document.getElementById('update-phase-select');
                    phaseSelect.innerHTML = '';
                    activeVersion.laborai_project_phases.forEach(ph => {
                        const opt = document.createElement('option');
                        opt.value = ph.id; 
                        opt.innerText = ph.name;
                        phaseSelect.appendChild(opt);
                    });
                }

                document.getElementById('toggle-add-update-form').classList.toggle('hidden', !isAdminMode);

                if (activeVersion) {
                    const vDiv = document.createElement('div');
                    const phases = version.laborai_project_phases.sort((a,b) => a.phase_order - b.phase_order);
                    
                    phases.forEach(phase => {
                        const isCompleted = phase.status === 'completed';
                        const isInProgress = phase.status === 'in_progress';
                        
                        const pHeader = document.createElement('div');
                        pHeader.className = `phase-header ${isInProgress ? 'active' : ''}`;
                        pHeader.style.borderColor = isCompleted ? 'var(--success-color)' : (isInProgress ? 'var(--primary-accent)' : 'var(--border-dark)');
                        
                        pHeader.onclick = (e) => {
                            if (!e.target.closest('button')) {
                                pHeader.classList.toggle('expanded');
                            }
                        };

                        let phaseActions = '';
                        if (isAdminMode) {
                            const status = phase.status;
                            let startPauseButton = status === 'pending' ? `<button class="icon-btn secondary" title="Marcar como 'Em Andamento'" onclick="changePhaseStatus('${phase.id}', 'in_progress')">‚ñ∂ Iniciar</button>` : (status === 'in_progress' ? `<button class="icon-btn secondary" title="Pausar e voltar para 'Pendente'" onclick="changePhaseStatus('${phase.id}', 'pending')">|| Pausar</button>` : '');
                            let completeReopenButton = status === 'in_progress' ? `<button class="icon-btn secondary" style="background-color: rgba(34, 197, 94, 0.1); color: var(--success-color);" title="Concluir Fase" onclick="changePhaseStatus('${phase.id}', 'completed')">‚úÖ Concluir</button>` : (status === 'completed' ? `<button class="icon-btn secondary" title="Reabrir Fase (volta para 'Em Andamento')" onclick="changePhaseStatus('${phase.id}', 'in_progress')">‚Ü©Ô∏è Reabrir</button>` : '');
                            phaseActions = `<div class="phase-actions" style="display:flex; gap:8px;">${startPauseButton}${completeReopenButton}</div>`;
                        }

                        pHeader.innerHTML = `
                            <div>
                                <h4 style="margin:0;">${phase.name}</h4>
                                <small style="color:${isCompleted ? 'var(--success-color)' : (isInProgress ? 'var(--primary-accent)' : 'var(--text-secondary)')}">
                                    ${phase.status === 'pending' ? 'Pendente' : phase.status === 'in_progress' ? 'Em Andamento' : 'Conclu√≠do'}
                                </small>
                            </div>
                            ${phaseActions}
                        `;
                        vDiv.appendChild(pHeader);

                        const pContent = document.createElement('div');
                        pContent.className = 'phase-content';
                        phase.laborai_phase_updates.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(upd => {
                            const uDiv = document.createElement('div');
                            uDiv.className = 'update';
                            
                            let content = `<p style="margin-top:5px;">${upd.description || ''}</p>`;
                            if (upd.update_type === 'image' && upd.content_url) {
                                const directImageUrl = getGoogleDriveDirectImage(upd.content_url);
                                if (directImageUrl) { 
                                    const safeUpd = JSON.stringify(upd).replace(/'/g, "&apos;");
                                    content += `<img src="${directImageUrl}" onclick='openImageLightbox(${safeUpd})' onerror="this.style.display='none'" style="margin-top:10px; display: block; border-radius: 4px; max-width: 100%;">`;
                                }
                            }
                            if (upd.link_url) {
                                content += `<a href="${upd.link_url}" target="_blank" style="color:var(--primary-accent); display:block; margin-top:10px;">üîó Acessar Link</a>`;
                            }

                            let updActions = '';
                            if (isAdminMode) {
                                const safeUpd = JSON.stringify(upd).replace(/'/g, "&apos;");
                                updActions = `
                                    <div class="update-actions">
                                        <button class="icon-btn secondary" title="Editar" onclick='handleEditUpdate(${safeUpd})'>‚úèÔ∏è</button>
                                        <button class="icon-btn" style="background:#25D366; color:white;" title="Notificar WhatsApp" onclick="notifyWhatsApp('${upd.id}', '${project.id}')">üì±</button>
                                        <button class="icon-btn danger" title="Excluir" onclick="deleteUpdate('${upd.id}')">üóëÔ∏è</button>
                                    </div>
                                `;
                            }

                            uDiv.innerHTML = `${updActions}<strong>${upd.title}</strong><small style="display:block; color:var(--text-secondary);">${new Date(upd.created_at).toLocaleString('pt-BR')}</small>${content}`;
                            pContent.appendChild(uDiv);
                        });
                        vDiv.appendChild(pContent);
                    });
                    
                    contentDiv.appendChild(vDiv);
                }
            }

            // --- FUN√á√ïES DE NAVEGA√á√ÉO E L√ìGICA ---

            window.openClientProjects = (clientId) => {
                state.currentClientId = clientId;
                renderHeader();
                renderProjectList(clientId);
                showView('projectList');
            };

            window.openProjectDetail = (projectId) => {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) return;

                renderProjectDetail(projectId);

                const tabContainer = document.querySelector('#project-detail-view .tab-container');
                const btnTimeline = document.getElementById('btn-view-timeline');
                const btnReports = document.getElementById('btn-view-reports');
                const timelineContent = document.getElementById('project-timeline-content');
                const reportsContent = document.getElementById('project-reports-content');

                const automationKeywords = ['Plano de Corte', 'Otimiza√ß√£o', 'Calculadora'];
                const isAutomationProject = automationKeywords.some(key => project.name.includes(key));

                if (isAutomationProject) {
                    tabContainer.classList.remove('hidden');
                    timelineContent.classList.remove('hidden');
                    reportsContent.classList.add('hidden');
                    btnTimeline.style.background = 'var(--primary-accent)';
                    btnReports.style.background = 'transparent';

                    btnTimeline.onclick = () => {
                        timelineContent.classList.remove('hidden');
                        reportsContent.classList.add('hidden');
                        btnTimeline.style.background = 'var(--primary-accent)';
                        btnReports.style.background = 'transparent';
                    };

                    btnReports.onclick = () => {
                        timelineContent.classList.add('hidden');
                        reportsContent.classList.remove('hidden');
                        btnReports.style.background = 'var(--primary-accent)';
                        btnTimeline.style.background = 'transparent';
                        renderAutomationReports(projectId);
                    };
                } else {
                    tabContainer.classList.add('hidden');
                    timelineContent.classList.remove('hidden');
                    reportsContent.classList.add('hidden');
                }

                document.getElementById('report-search').oninput = (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#automation-history-body tr');
                    rows.forEach(row => {
                        row.style.display = (row.dataset.productName && row.dataset.productName.includes(searchTerm)) ? '' : 'none';
                    });
                };
                
                showView('projectDetail');
            };


            document.getElementById('client-view-toggle').addEventListener('change', (e) => {
                state.isSimulatingClient = e.target.checked;
                renderHeader();
                if (!document.getElementById('project-detail-view').classList.contains('hidden')) {
                    openProjectDetail(state.currentProjectId); // Re-run logic to show/hide tabs
                } else if (!document.getElementById('client-list-view').classList.contains('hidden')) {
                    renderClientList();
                } else if (!document.getElementById('project-list-view').classList.contains('hidden')) {
                    renderProjectList(state.currentClientId);
                }
            });

            // FECHAMENTO DO LIGHTBOX AJUSTADO
            document.getElementById('image-lightbox').addEventListener('click', (e) => {
                if (e.target.id === 'image-lightbox' || e.target.classList.contains('modal-content')) {
                    document.getElementById('image-lightbox').classList.add('hidden');
                }
            });

            // Refatora√ß√£o: Bot√£o de Adicionar Atualiza√ß√£o abre Modal
            document.getElementById('toggle-add-update-form').addEventListener('click', () => {
                const formContainer = document.getElementById('add-update-form-container');
                showGenericModal({
                    title: 'Adicionar Nova Atualiza√ß√£o',
                    bodyHtml: formContainer.innerHTML,
                    buttons: []
                });

                const modalForm = document.querySelector('#generic-modal #add-update-form');
                if(modalForm) {
                    modalForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const btn = modalForm.querySelector('button[type="submit"]');
                        btn.disabled = true; btn.innerText = 'Salvando...';

                        try {
                            const formData = new FormData();
                            formData.append('phaseId', modalForm.querySelector('#update-phase-select').value);
                            formData.append('title', modalForm.querySelector('#update-title').value);
                            formData.append('description', modalForm.querySelector('#update-description').value);
                            formData.append('link', modalForm.querySelector('#update-link').value);
                            formData.append('file', modalForm.querySelector('#update-file').files[0]);

                            await handleSaveUpdate(formData);
                            
                            Toast.success('Atualiza√ß√£o criada!');
                            await loadData();
                            openProjectDetail(state.currentProjectId);
                            document.getElementById('generic-modal').classList.add('hidden');
                        } catch (err) {
                            Toast.error('Falha ao salvar. Verifique os dados.');
                        } finally {
                            btn.disabled = false; btn.innerText = 'Publicar Atualiza√ß√£o';
                        }
                    };
                }
            });

            // --- FUN√á√ïES ADMIN / ACTIONS (Via N8N & Modal Customizado) ---

            async function handleSaveUpdate(formData, updateId = null) {
                let url = `${HOOKS.SALVAR_ATUALIZACAO}?title=${encodeURIComponent(formData.get('title'))}&description=${encodeURIComponent(formData.get('description'))}&contentUrl=${encodeURIComponent(formData.get('link'))}`;
                if (updateId) url += `&updateId=${updateId}`;
                else url += `&phaseId=${formData.get('phaseId')}`;

                let fetchOptions = { method: 'POST' };
                const file = formData.get('file');
                if (file) {
                    url += `&fileName=${encodeURIComponent(file.name)}`;
                    fetchOptions.body = file;
                }
                
                await fetch(url, fetchOptions);
            }

            window.notifyWhatsApp = (updateId, projectId) => showGenericModal({
                title: 'Enviar Notifica√ß√£o',
                bodyHtml: '<p>Deseja enviar notifica√ß√£o via WhatsApp para todos os contatos deste cliente?</p>',
                buttons: [{
                    label: 'Enviar',
                    classes: 'primary', 
                    onClick: async () => {
                        await fetch(HOOKS.NOTIFICAR_WHATSAPP, { method: 'POST', body: JSON.stringify({ updateId, projectId }) });
                        Toast.success('Notifica√ß√£o enviada!');
                    }
                }]
            });

            document.getElementById('upload-logo-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('upload-logo-button');
                const file = document.getElementById('logo-file-input').files[0];
                const clientId = document.getElementById('logo-client-select').value;
                btn.innerText = 'Enviando...'; btn.disabled = true;
                
                try {
                    const url = `${HOOKS.ATUALIZAR_LOGO}?clientId=${clientId}&fileName=${encodeURIComponent(file.name)}`;
                    const res = await fetch(url, { method: 'POST', body: file });
                    if(!res.ok) throw new Error('Falha no upload');
                    Toast.success('Logo atualizada!');
                    await loadData();
                    if(state.isAdmin) renderClientList();
                    e.target.reset();
                } catch(err) { Toast.error(err.message); }
                finally { btn.innerText = 'Salvar Logo'; btn.disabled = false; }
            });

            window.openContactsModal = async (clientId, clientName) => {
                state.currentManageClientId = clientId;
                const modal = document.getElementById('contacts-modal');
                modal.querySelector('#contacts-modal-client-name').innerText = clientName;
                modal.classList.remove('hidden');
                
                const listEl = modal.querySelector('#contacts-list');
                listEl.innerHTML = 'Carregando...';
                
                const { data } = await supabaseClient.from('laborai_client_contacts').select('*').eq('client_id', clientId);
                listEl.innerHTML = '';
                if(data) data.forEach(c => {
                    const item = document.createElement('div');
                    item.className = 'contact-item';
                    item.innerHTML = `<div><strong>${c.name}</strong> (${c.role || '-'})<br><small>${c.whatsapp}</small></div><button class="danger icon-btn" onclick="deleteContact('${c.id}')">üóëÔ∏è</button>`;
                    listEl.appendChild(item);
                });
            };

            document.getElementById('add-contact-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('add-contact-btn'); btn.disabled = true;
                try {
                    await fetch(HOOKS.CRIAR_CONTATO, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({
                            clientId: state.currentManageClientId,
                            name: document.getElementById('contact-name').value,
                            role: document.getElementById('contact-role').value,
                            whatsapp: document.getElementById('contact-whatsapp').value
                        })
                    });
                    Toast.success('Contato adicionado!');
                    e.target.reset();
                    const client = state.clients.find(c => c.id === state.currentManageClientId);
                    if (client) openContactsModal(client.id, client.name);
                } catch(err) { Toast.error('Erro ao criar contato'); }
                finally { btn.disabled = false; }
            });

            window.deleteContact = async (id) => showGenericModal({
                title: 'Excluir Contato',
                bodyHtml: '<p>Tem certeza que deseja excluir este contato?</p>',
                buttons: [{
                    label: 'Excluir',
                    classes: 'danger',
                    onClick: async () => {
                        await fetch(HOOKS.EXCLUIR_CONTATO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contactId: id }) });
                        const client = state.clients.find(c => c.id === state.currentManageClientId);
                        if (client) openContactsModal(client.id, client.name);
                    }
                }]
            });

            window.handleEditProject = (project) => showGenericModal({
                title: 'Editar Projeto',
                bodyHtml: `<label>Nome do projeto:</label><input type="text" id="edit-project-name" value="${escapeHtml(project.name)}" required style="margin-bottom: 10px; width: 100%; box-sizing: border-box;"><label>Descri√ß√£o:</label><textarea id="edit-project-description" rows="4" style="width: 100%; box-sizing: border-box;">${escapeHtml(project.description || '')}</textarea>`,
                buttons: [{
                    label: 'Salvar',
                    classes: 'primary',
                    onClick: async () => {
                        const updates = [
                            { field: 'name', value: document.getElementById('edit-project-name').value },
                            { field: 'description', value: document.getElementById('edit-project-description').value }
                        ];
                        await fetch(HOOKS.EDITAR_PROJETO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ projectId: project.id, updates }) });
                        Toast.success('Projeto atualizado');
                        await loadData(); 
                        renderProjectList(state.currentClientId);
                    }
                }]
            });

            window.handleDeleteProject = async (projectId) => showGenericModal({
                title: 'Confirmar Exclus√£o',
                bodyHtml: '<p style="color:var(--error-color);">ATEN√á√ÉO: Isso excluir√° o projeto e todo o hist√≥rico. Esta a√ß√£o n√£o pode ser desfeita.</p>',
                buttons: [{
                    label: 'Excluir Projeto',
                    classes: 'danger',
                    onClick: async () => {
                        await fetch(HOOKS.EXCLUIR_PROJETO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ projectId }) });
                        Toast.success('Projeto exclu√≠do');
                        await loadData(); 
                        renderProjectList(state.currentClientId);
                    }
                }]
            });

            window.handleEditUpdate = async (update) => showGenericModal({
                title: 'Editar Atualiza√ß√£o',
                bodyHtml: `<label>T√≠tulo:</label><input type="text" id="edit-update-title" value="${escapeHtml(update.title)}" required style="margin-bottom: 10px; width: 100%; box-sizing: border-box;"><label>Descri√ß√£o:</label><textarea id="edit-update-desc" rows="4" style="width: 100%; box-sizing: border-box;">${escapeHtml(update.description || '')}</textarea><label>Link (deixe em branco para remover):</label><input type="url" id="edit-update-link" value="${update.link_url ? escapeHtml(update.link_url) : ''}" style="margin-bottom: 10px; width: 100%; box-sizing: border-box;"><label style="font-size: 0.9em; color: var(--text-secondary);">Substituir Arquivo (opcional):</label>${update.update_type === 'image' && update.content_url ? `<img src="${getGoogleDriveDirectImage(update.content_url)}" style="max-width:100px; display:block; margin-bottom:5px;">` : ''}<input type="file" id="edit-update-file">`,
                buttons: [{
                    label: 'Salvar Altera√ß√µes',
                    classes: 'primary',
                    onClick: async () => {
                        const formData = new FormData();
                        formData.append('title', document.getElementById('edit-update-title').value);
                        formData.append('description', document.getElementById('edit-update-desc').value);
                        formData.append('link', document.getElementById('edit-update-link').value);
                        formData.append('file', document.getElementById('edit-update-file').files[0]);
                        await handleSaveUpdate(formData, update.id);
                        Toast.success('Atualiza√ß√£o salva!');
                        await loadData();
                        openProjectDetail(state.currentProjectId);
                    }
                }]
            });

            window.deleteUpdate = async (updateId) => showGenericModal({
                title: 'Excluir Atualiza√ß√£o',
                bodyHtml: '<p>Deseja remover esta atualiza√ß√£o da timeline?</p>',
                buttons: [{
                    label: 'Excluir',
                    classes: 'danger',
                    onClick: async () => {
                        await fetch(HOOKS.EXCLUIR_ATUALIZACAO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ updateId }) });
                        Toast.success('Atualiza√ß√£o removida');
                        await loadData(); 
                        openProjectDetail(state.currentProjectId);
                    }
                }]
            });

            window.changePhaseStatus = async (phaseId, status) => {
                await fetch(HOOKS.ATUALIZAR_STATUS_FASE, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ phaseId, newStatus: status }) });
                Toast.success('Status da fase alterado');
                await loadData(); 
                openProjectDetail(state.currentProjectId);
            };

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value });
                if (error) Toast.error(error.message);
                else initApp(data.user);
            });

            document.getElementById('logout-button').addEventListener('click', () => { supabaseClient.auth.signOut(); window.location.reload(); });
            document.getElementById('admin-panel-button').addEventListener('click', () => { populateDropdowns(); showView('adminForms'); });
            document.getElementById('back-from-admin-panel').addEventListener('click', () => { renderProjectList(state.currentClientId); showView('projectList'); });
            document.getElementById('back-to-clients-button').addEventListener('click', () => { state.currentClientId = null; renderHeader(); showView('clientList'); });
            document.getElementById('back-to-projects-button').addEventListener('click', () => { renderProjectList(state.currentClientId); showView('projectList'); });

            document.getElementById('create-client-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await fetch(HOOKS.CRIAR_CLIENTE, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ clientName: document.getElementById('new-client-name').value }) });
                Toast.success('Cliente criado'); e.target.reset(); await loadData(); populateDropdowns();
            });

            document.getElementById('phase-template-select').addEventListener('change', (e) => document.getElementById('new-project-phases').classList.toggle('hidden', e.target.value !== 'Customizado'));
            
            document.getElementById('create-project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const template = state.phaseTemplates.find(t => t.name === document.getElementById('phase-template-select').value);
                const phases = template.name === 'Customizado' ? document.getElementById('new-project-phases').value.split('\n') : template.phases;
                await fetch(HOOKS.CRIAR_PROJETO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ clientId: document.getElementById('project-client-select').value, projectName: document.getElementById('new-project-name').value, description: document.getElementById('new-project-description').value, phases }) });
                Toast.success('Projeto criado'); e.target.reset(); await loadData();
            });

            document.getElementById('progress-slider').addEventListener('input', (e) => document.getElementById('progress-percentage-display').innerText = e.target.value + '%');
            document.getElementById('save-progress-button').addEventListener('click', async () => {
                await fetch(HOOKS.ATUALIZAR_PROGRESSO, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ versionId: state.currentVersionId, newProgress: parseInt(document.getElementById('progress-slider').value) }) });
                Toast.success('Progresso salvo');
                await loadData();
                openProjectDetail(state.currentProjectId);
            });
            
            function populateDropdowns() {
                const selects = [document.getElementById('logo-client-select'), document.getElementById('project-client-select'), document.getElementById('user-client-select')];
                selects.forEach(s => s.innerHTML = '<option value="">Selecione...</option>');
                state.clients.forEach(c => {
                    const opt = `<option value="${c.id}">${c.name}</option>`;
                    selects.forEach(s => s.innerHTML += opt);
                });

                const tmplSel = document.getElementById('phase-template-select');
                tmplSel.innerHTML = '';
                state.phaseTemplates.forEach(t => tmplSel.innerHTML += `<option value="${t.name}">${t.name}</option>`);
            }

            async function initApp(user) {
                state.user = user;
                state.isAdmin = user.user_metadata.role === 'admin';
                await loadData();
                renderHeader();
                showView('app');
                if (state.isAdmin) {
                    renderClientList();
                    showView('clientList');
                } else {
                    renderProjectList(user.user_metadata.clientId);
                    showView('projectList');
                }
            }

            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) initApp(session.user);
                else showView('login');
            });
        });
    </script>
</body>
</html>
