<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Projetos - LaborAI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --background-dark: #111827; --surface-dark: #1f2937; --border-dark: #374151;
            --primary-accent: #3b82f6; --primary-accent-hover: #60a5fa; --text-primary: #f9fafb;
            --text-secondary: #9ca3af; --success-color: #22c55e; --warning-color: #f59e0b; --error-color: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-dark); color: var(--text-primary); margin: 0; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Login */
        #login-section { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-card { background: var(--surface-dark); padding: 40px; border-radius: 12px; border: 1px solid var(--border-dark); width: 100%; max-width: 400px; text-align: center; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--border-dark); border-radius: 6px; box-sizing: border-box; background-color: #374151; color: var(--text-primary); font-size: 16px; font-family: 'Inter', sans-serif; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; background-color: var(--primary-accent); color: white; font-weight: 500; font-size: 16px; cursor: pointer; transition: background-color 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        button:hover { background-color: var(--primary-accent-hover); }
        button:disabled { background-color: #4b5563; cursor: not-allowed; }
        
        /* Button Variants */
        button.secondary { background: transparent; border: 1px solid var(--border-dark); color: var(--text-primary); }
        button.secondary:hover { background: var(--border-dark); }
        button.danger { background-color: rgba(239, 68, 68, 0.2); color: var(--error-color); border: 1px solid var(--error-color); }
        button.danger:hover { background-color: rgba(239, 68, 68, 0.3); }
        button.icon-btn { width: auto; padding: 6px 12px; font-size: 14px; }
        
        /* Header */
        #app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--border-dark); margin-bottom: 24px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .client-logo-header-img { height: 32px; object-fit: contain; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-right: 20px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .project-card, .client-card { background: var(--surface-dark); padding: 20px; border-radius: 8px; border: 1px solid var(--border-dark); cursor: pointer; transition: transform 0.2s, border-color 0.2s; position: relative; }
        .project-card:hover, .client-card:hover { transform: translateY(-3px); border-color: var(--primary-accent); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .client-logo-thumb { height: 40px; max-width: 100px; object-fit: contain; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 4px; }
        
        /* Timeline/Details - Accordion Styles */
        .phase-header { border: 2px solid var(--border-dark); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: var(--surface-dark); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .phase-header.active { border-color: var(--primary-accent); animation: pulse-border 3s infinite; }
        .phase-header::after { content: '‚ñº'; margin-left: 10px; transition: transform 0.3s; font-size: 0.8em; }
        .phase-header.expanded::after { transform: rotate(180deg); }
        
        .phase-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .phase-header.expanded + .phase-content { max-height: 2000px; transition: max-height 0.5s ease-in; }

        /* Phase Actions Hover Effect */
        .phase-header .phase-actions { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .phase-header:hover .phase-actions { opacity: 1; }

        .update { margin-left: 20px; margin-bottom: 12px; padding: 15px; background: var(--background-dark); border-left: 3px solid var(--border-dark); border-radius: 0 8px 8px 0; position: relative; }
        .update-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; opacity: 0.7; }
        .update-actions:hover { opacity: 1; }
        .update img {
            max-height: 300px;
            width: auto;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .update img:hover {
            opacity: 0.8;
        }
        
        /* Admin Sections */
        .admin-section-card { border: 1px solid var(--border-dark); border-radius: 8px; padding: 20px; margin-top: 20px; background: var(--surface-dark); }
        .admin-toolbar { display: flex; gap: 8px; margin-top: 10px; }
        
        /* Toast */
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.75rem; max-width: 420px; }
        .toast { padding: 1rem 1.25rem; border-radius: 8px; background-color: var(--surface-dark); border-left: 4px solid; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
        .toast.success { border-color: var(--success-color); } .toast.error { border-color: var(--error-color); } .toast.info { border-color: var(--primary-accent); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* Modals */
        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface-dark); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; border: 1px solid var(--border-dark); max-height: 90vh; overflow-y: auto; }
        
        /* Contacts List in Modal */
        .contact-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-dark); }
        .contact-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- TELA DE LOGIN -->
    <div id="login-section">
        <div class="login-card">
            <h2>Portal LaborAI</h2>
            <p>Acesse para gerenciar seus projetos.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" placeholder="Sua senha" required>
                <button type="submit">Entrar</button>
            </form>
        </div>
    </div>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div id="app-container" class="container hidden">
        <header id="app-header">
            <div class="header-left">
                <img id="header-client-logo" class="client-logo-header-img hidden" alt="Logo">
                <div>
                    <strong style="font-size: 1.2rem;">LaborAI</strong>
                    <span id="header-client-name" style="color: var(--text-secondary); margin-left: 8px;"></span>
                </div>
            </div>
            <div style="display: flex; align-items: center;">
                
                <div id="admin-simulation-toggle" class="toggle-container hidden">
                    <span style="font-size: 0.9em; color: var(--text-secondary);">Ver como Cliente</span>
                    <label class="switch">
                        <input type="checkbox" id="client-view-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <span id="user-email" style="font-size: 0.9em; margin-right: 16px; color: var(--text-secondary);"></span>
                
                <button id="admin-panel-button" class="hidden secondary" style="width: auto; padding: 6px 12px; margin-right: 10px;">
                    ‚öôÔ∏è Painel & Cria√ß√£o
                </button>
                
                <button id="logout-button" class="secondary" style="width: auto; padding: 6px 12px;">Sair</button>
            </div>
        </header>

        <main id="main-content">
            <!-- VIEW 1: Lista de Clientes (Home do Admin) -->
            <div id="client-list-view" class="hidden">
                <h3>Meus Clientes</h3>
                <div id="clients-list" class="card-grid"></div>
            </div>

            <!-- VIEW 2: Lista de Projetos -->
            <div id="project-list-view" class="hidden">
                <button id="back-to-clients-button" class="secondary hidden" style="margin-bottom: 20px;">&larr; Voltar para Clientes</button>
                <h2 style="font-weight: 500; border-bottom: 1px solid var(--border-dark); padding-bottom: 16px; margin-bottom: 24px;">Projetos</h2>
                <div id="project-list-content" class="card-grid"></div>
            </div>

            <!-- VIEW 3: Detalhes do Projeto (Timeline) -->
            <div id="project-detail-view" class="hidden">
                <button id="back-to-projects-button" class="secondary" style="margin-bottom: 20px;">&larr; Voltar para Projetos</button>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 id="project-detail-name" style="margin: 0;">Nome do Projeto</h2>
                    <button id="toggle-add-update-form" class="primary icon-btn hidden">[+] Nova Atualiza√ß√£o</button>
                </div>

                <div id="project-description-container" class="admin-section-card" style="margin-bottom: 24px; padding: 20px;">
                    <h3 style="margin-top: 0; margin-bottom: 10px;">Sobre o Projeto</h3>
                    <p id="project-detail-description" style="color: var(--text-secondary); margin: 0; white-space: pre-wrap;"></p>
                </div>

                <div id="progress-view-container" class="admin-section-card" style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">üìä Progresso</h3>
                        <span id="progress-percentage-display" style="font-weight: bold; font-size: 1.1rem;">0%</span>
                    </div>
                    <div style="height: 8px; background-color: var(--border-dark); border-radius: 4px; overflow: hidden;">
                        <div id="progress-bar-fill" style="width: 0%; height: 100%; background-color: var(--primary-accent); transition: width 0.3s;"></div>
                    </div>
                    <div id="admin-progress-controls" class="hidden" style="margin-top: 15px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="range" min="0" max="100" value="0" id="progress-slider" style="flex: 1;">
                            <button id="save-progress-button" style="width: auto;">Salvar</button>
                        </div>
                    </div>
                </div>

                <div id="project-detail-content" style="margin-top: 24px;"></div>

                <div id="add-update-form-container" class="hidden">
                    <form id="add-update-form">
                        <select id="update-phase-select" required></select>
                        <input type="text" id="update-title" placeholder="T√≠tulo da atualiza√ß√£o" required>
                        <textarea id="update-description" rows="3" placeholder="Descri√ß√£o detalhada..." required></textarea>
                        <input type="url" id="update-link" placeholder="Anexar Link (Opcional)">
                        <label for="update-file" style="font-size: 0.9em; color: var(--text-secondary);">Anexar Arquivo (Opcional):</label>
                        <input type="file" id="update-file">
                        <button type="submit" id="add-update-button" style="margin-top:15px;">Publicar Atualiza√ß√£o</button>
                    </form>
                </div>
            </div>

            <!-- VIEW 4: Painel Administrativo -->
            <div id="admin-forms-view" class="hidden">
                <button id="back-from-admin-panel" class="secondary" style="margin-bottom: 20px;">&larr; Voltar</button>
                <h2>Painel de Gest√£o & Cria√ß√£o</h2>
                
                <div class="card-grid">
                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üñºÔ∏è Logo do Cliente</h3>
                        <form id="upload-logo-form">
                            <label>Cliente:</label>
                            <select id="logo-client-select" required></select>
                            <label>Arquivo (PNG/JPG/SVG):</label>
                            <input type="file" id="logo-file-input" accept="image/png, image/jpeg, image/svg+xml" required>
                            <button type="submit" id="upload-logo-button">Salvar Logo</button>
                        </form>
                    </div>

                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üè¢ Novo Cliente</h3>
                        <form id="create-client-form">
                            <label>Nome da Empresa:</label>
                            <input type="text" id="new-client-name" placeholder="Ex: LaborAI Corp" required>
                            <button type="submit" id="create-client-button">Criar Cliente</button>
                        </form>
                    </div>

                    <div class="admin-section-card" style="margin-top: 0;">
                        <h3>üë§ Novo Usu√°rio</h3>
                        <form id="create-user-form">
                            <label>Associar ao Cliente:</label>
                            <select id="user-client-select" required></select>
                            <label>E-mail:</label>
                            <input type="email" id="new-user-email" required>
                            <label>Senha Provis√≥ria:</label>
                            <input type="password" id="new-user-password" required>
                            <button type="submit" id="create-user-button">Criar Usu√°rio</button>
                        </form>
                    </div>
                </div>

                <div class="admin-section-card">
                    <h3>üöÄ Novo Projeto</h3>
                    <form id="create-project-form">
                        <label>Cliente:</label>
                        <select id="project-client-select" required></select>
                        <label>Nome do Projeto:</label>
                        <input type="text" id="new-project-name" required>
                        <label>Descri√ß√£o:</label>
                        <textarea id="new-project-description" rows="2"></textarea>
                        <label>Template de Fases:</label>
                        <select id="phase-template-select" required></select>
                        <textarea id="new-project-phases" rows="4" class="hidden" placeholder="Fase 1..."></textarea>
                        <button type="submit" id="create-project-button">Criar Projeto</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <div id="contacts-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Gerenciar Contatos</h3>
            <p id="contacts-modal-client-name" style="color: var(--text-secondary); margin-bottom: 15px;"></p>
            <div id="contacts-list-container" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-dark); border-radius: 6px;"></div>
            <h4 style="border-top: 1px solid var(--border-dark); padding-top: 15px;">Adicionar Novo</h4>
            <form id="add-contact-form">
                <input type="text" id="contact-name" placeholder="Nome" required style="margin-bottom: 8px;">
                <input type="text" id="contact-role" placeholder="Cargo" style="margin-bottom: 8px;">
                <input type="text" id="contact-whatsapp" placeholder="WhatsApp (55119...)" required style="margin-bottom: 8px;">
                <button type="submit" id="add-contact-btn">Adicionar Contato</button>
            </form>
            <button class="secondary" onclick="document.getElementById('contacts-modal').classList.add('hidden')" style="margin-top: 15px; width: 100%;">Fechar</button>
        </div>
    </div>

    <div id="generic-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="modal-title">T√≠tulo</h3>
            <div id="modal-body" style="margin: 20px 0;"></div>
            <div id="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;"></div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="image-lightbox" class="modal hidden">
        <div class="modal-content" style="max-width: 90%; max-height: 90%; display: flex; gap: 20px; padding: 20px;">
            <div style="flex: 2; display: flex; justify-content: center; align-items: center; position: relative;">
                <img id="lightbox-img" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                <a id="lightbox-download-link" href="#" download class="icon-btn" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5);">üì• Download</a>
            </div>
            <div id="lightbox-info-panel" style="flex: 1; border-left: 1px solid var(--border-dark); padding-left: 20px; overflow-y: auto;">
                <h3 id="lightbox-update-title" style="margin-top: 0;"></h3>
                <small id="lightbox-update-date" style="color: var(--text-secondary); display: block; margin-bottom: 15px;"></small>
                <p id="lightbox-update-description"></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://vzmhnponxmrvoqctmpty.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6bWhucG9ueG1ydm9xY3RtcHR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3Mzg5MjYsImV4cCI6MjA3MDMxNDkyNn0.sSfMCpPKwFp2lVLuWnFN066OT0lluMb-sd-kWb1PePg';
            
            const N8N_BASE = 'https://n8n-n8n.znxk1t.easypanel.host/webhook';
            const HOOKS = {
                ATUALIZAR_LOGO: `${N8N_BASE}/atualizar-logo-cliente`,
                CRIAR_CLIENTE: `${N8N_BASE}/criar-novo-cliente`,
                CRIAR_USUARIO: `${N8N_BASE}/criar-novo-usuario`,
                CRIAR_PROJETO: `${N8N_BASE}/criar-novo-projeto`,
                SALVAR_ATUALIZACAO: `${N8N_BASE}/salvar-atualizacao`,
                ATUALIZAR_PROGRESSO: `${N8N_BASE}/atualizar-progresso-projeto`,
                ATUALIZAR_STATUS_FASE: `${N8N_BASE}/atualizar-status-fase`,
                NOTIFICAR_WHATSAPP: `${N8N_BASE}/notificar-whatsapp`,
                CRIAR_CONTATO: `${N8N_BASE}/criar-contato-cliente`,
                EXCLUIR_CONTATO: `${N8N_BASE}/excluir-contato-cliente`,
                EDITAR_PROJETO: `${N8N_BASE}/editar-projeto`, 
                EXCLUIR_PROJETO: `${N8N_BASE}/excluir-projeto`, 
                EXCLUIR_ATUALIZACAO: `${N8N_BASE}/excluir-atualizacao`
            };

            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let state = {
                user: null, isAdmin: false, isSimulatingClient: false,
                clients: [], projects: [], contacts: [],
                currentClientId: null, currentProjectId: null, currentVersionId: null,
                phaseTemplates: [
                    { name: "Padr√£o (3 Fases)", phases: ["Levantamento", "Desenvolvimento", "Valida√ß√£o"] },
                    { name: "Completo (5 Fases)", phases: ["Diagn√≥stico", "Design", "Dev", "Homologa√ß√£o", "Go-Live"] },
                    { name: "Customizado", phases: [] }
                ]
            };

            const Toast = {
                container: document.getElementById('toast-container'),
                show(type, msg) {
                    const el = document.createElement('div'); el.className = `toast ${type}`;
                    el.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${msg}</span>`;
                    this.container.appendChild(el);
                    setTimeout(() => el.remove(), 4000);
                },
                success(m) { this.show('success', m); }, error(m) { this.show('error', m); }
            };

            function escapeHtml(text) {
                if (!text) return '';
                return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            // --- FUN√á√ÉO CORRIGIDA ---
            function getGoogleDriveDirectImage(url) {
                if (!url || typeof url !== 'string' || url === 'null' || url === 'undefined' || url.trim() === '') return null;
                let match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}`;
                match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}`;
                return null;
            }

            window.showGenericModal = function({ title, bodyHtml, buttons }) {
                const modal = document.getElementById('generic-modal');
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = bodyHtml;
                const footer = document.getElementById('modal-footer');
                footer.innerHTML = '';
                const closeModal = () => modal.classList.add('hidden');
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'secondary';
                cancelButton.innerText = 'Cancelar';
                cancelButton.onclick = closeModal;
                footer.appendChild(cancelButton);

                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.innerText = btnConfig.label;
                    if (btnConfig.classes) button.className = btnConfig.classes;
                    button.onclick = async () => {
                        button.disabled = true;
                        try { await btnConfig.onClick(); closeModal(); }
                        catch (e) { Toast.error("Erro na a√ß√£o"); }
                        finally { button.disabled = false; }
                    };
                    footer.appendChild(button);
                });
                modal.classList.remove('hidden');
            };

            const Views = {
                login: document.getElementById('login-section'), app: document.getElementById('app-container'),
                clientList: document.getElementById('client-list-view'), projectList: document.getElementById('project-list-view'),
                projectDetail: document.getElementById('project-detail-view'), adminForms: document.getElementById('admin-forms-view')
            };

            function showView(viewName) {
                Object.values(Views).forEach(el => { if(el && el !== Views.app) el.classList.add('hidden'); });
                if (viewName !== 'login') Views.app.classList.remove('hidden');
                if (Views[viewName]) Views[viewName].classList.remove('hidden');
            }

            async function loadData() {
                try {
                    let query = supabaseClient.from('laborai_projects').select(`*, laborai_clients(name, logo_url), laborai_project_versions(*, laborai_project_phases(*, laborai_phase_updates(*)))`).order('created_at', { ascending: false });
                    if (!state.isAdmin) query = query.eq('client_id', state.user.user_metadata.clientId);
                    const { data: projData } = await query;
                    state.projects = projData || [];
                    if (state.isAdmin) {
                        const { data: clientData } = await supabaseClient.from('laborai_clients').select('*').order('name');
                        state.clients = clientData || [];
                    }
                } catch (e) { Toast.error('Erro ao carregar dados'); }
            }

            function renderHeader() {
                document.getElementById('user-email').textContent = state.user.email;
                const adminPanelBtn = document.getElementById('admin-panel-button');
                if (state.isAdmin) {
                    document.getElementById('admin-simulation-toggle').classList.remove('hidden');
                    adminPanelBtn.classList.toggle('hidden', !state.currentClientId);
                } else {
                    adminPanelBtn.classList.add('hidden');
                    document.getElementById('admin-simulation-toggle').classList.add('hidden');
                }

                const logoImg = document.getElementById('header-client-logo');
                const nameSpan = document.getElementById('header-client-name');
                const clientIdToShow = state.isAdmin ? state.currentClientId : state.user.user_metadata.clientId;
                
                const client = state.clients.find(c => c.id === clientIdToShow) || (state.projects.find(p => p.client_id === clientIdToShow)?.laborai_clients);

                if (client) {
                    nameSpan.textContent = `| ${client.name}`;
                    if (client.logo_url) {
                        logoImg.src = client.logo_url.replace('/view', '/uc');
                        logoImg.classList.remove('hidden');
                    } else { logoImg.classList.add('hidden'); }
                } else {
                    logoImg.classList.add('hidden');
                    nameSpan.textContent = state.isAdmin ? (state.isSimulatingClient ? " (Visualiza√ß√£o)" : " | Admin") : "";
                }
            }

            function renderClientList() {
                const container = document.getElementById('clients-list');
                container.innerHTML = '';
                state.clients.forEach(client => {
                    const card = document.createElement('div');
                    card.className = 'client-card';
                    card.onclick = (e) => { if(e.target.tagName !== 'BUTTON') openClientProjects(client.id); };
                    const logoHtml = client.logo_url ? `<img src="${client.logo_url.replace('/view', '/uc')}" class="client-logo-thumb">` : `<div style="width:40px;height:40px;background:#374151;border-radius:4px;display:flex;align-items:center;justify-content:center;">${client.name.substring(0,2).toUpperCase()}</div>`;
                    card.innerHTML = `<div class="card-header"><div><h4>${client.name}</h4></div>${logoHtml}</div>
                                      <div style="margin-top:15px; display:flex; gap:8px;">
                                        <button class="secondary icon-btn" onclick="event.stopPropagation(); openContactsModal('${client.id}', '${client.name}')">üë• Contatos</button>
                                        <button class="secondary" style="flex:1" onclick="openClientProjects('${client.id}')">üìÇ Projetos</button>
                                      </div>`;
                    container.appendChild(card);
                });
            }

            function renderProjectList(clientId = null) {
                const container = document.getElementById('project-list-content');
                container.innerHTML = '';
                let filtered = state.projects;
                if (state.isAdmin && clientId) filtered = state.projects.filter(p => p.client_id === clientId);
                
                filtered.forEach(project => {
                    const latestVersion = project.laborai_project_versions?.[0];
                    const progress = latestVersion?.progress_percentage || 0;
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.onclick = () => openProjectDetail(project.id);
                    
                    let adminActions = '';
                    if (state.isAdmin && !state.isSimulatingClient) {
                        adminActions = `<div class="admin-toolbar" style="margin-top:15px; border-top:1px solid var(--border-dark); padding-top:10px;">
                                            <button class="secondary icon-btn" onclick="event.stopPropagation(); handleEditProject(${JSON.stringify(project).replace(/'/g, "&apos;")})">‚úèÔ∏è</button>
                                            <button class="danger icon-btn" onclick="event.stopPropagation(); handleDeleteProject('${project.id}')">üóëÔ∏è</button>
                                        </div>`;
                    }

                    card.innerHTML = `<div><h4>${project.name}</h4><small>${project.description || ''}</small>
                                      <div style="margin:10px 0;">
                                        <div style="display:flex;justify-content:space-between;font-size:0.85em;"><span>Progresso</span><span>${progress}%</span></div>
                                        <div style="height:6px;background:#374151;border-radius:3px;overflow:hidden;"><div style="height:100%;width:${progress}%;background:var(--primary-accent);"></div></div>
                                      </div></div>${adminActions}`;
                    container.appendChild(card);
                });
                document.getElementById('back-to-clients-button').classList.toggle('hidden', !state.isAdmin || !state.currentClientId);
            }

            function renderProjectDetail(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (!project) return;
                state.currentProjectId = projectId;
                document.getElementById('project-detail-name').innerText = project.name;
                document.getElementById('project-detail-description').innerText = project.description || 'Nenhuma descri√ß√£o.';

                const versions = project.laborai_project_versions || [];
                const activeVersion = versions[0];
                state.currentVersionId = activeVersion?.id;
                const progress = activeVersion?.progress_percentage || 0;

                document.getElementById('progress-percentage-display').innerText = `${progress}%`;
                document.getElementById('progress-bar-fill').style.width = `${progress}%`;
                
                const isAdminMode = state.isAdmin && !state.isSimulatingClient;
                document.getElementById('admin-progress-controls').classList.toggle('hidden', !isAdminMode);
                document.getElementById('toggle-add-update-form').classList.toggle('hidden', !isAdminMode);

                if (isAdminMode && activeVersion) {
                    document.getElementById('progress-slider').value = progress;
                    const phaseSelect = document.getElementById('update-phase-select');
                    phaseSelect.innerHTML = '';
                    activeVersion.laborai_project_phases.forEach(ph => {
                        const opt = document.createElement('option'); opt.value = ph.id; opt.innerText = ph.name;
                        phaseSelect.appendChild(opt);
                    });
                }

                const contentDiv = document.getElementById('project-detail-content');
                contentDiv.innerHTML = '';

                if (activeVersion) {
                    activeVersion.laborai_project_phases.sort((a,b) => a.phase_order - b.phase_order).forEach(phase => {
                        const isInProgress = phase.status === 'in_progress';
                        const isCompleted = phase.status === 'completed';
                        
                        const pHeader = document.createElement('div');
                        pHeader.className = `phase-header ${isInProgress ? 'active' : ''}`;
                        pHeader.style.borderColor = isCompleted ? 'var(--success-color)' : (isInProgress ? 'var(--primary-accent)' : 'var(--border-dark)');
                        
                        let phaseActions = '';
                        if (isAdminMode) {
                            phaseActions = `<div class="phase-actions" style="display:flex; gap:8px;">
                                <button class="icon-btn secondary" onclick="event.stopPropagation(); changePhaseStatus('${phase.id}', '${phase.status === 'pending' ? 'in_progress' : 'pending'}')">${phase.status === 'pending' ? '‚ñ∂ Iniciar' : '|| Pausar'}</button>
                                <button class="icon-btn secondary" onclick="event.stopPropagation(); changePhaseStatus('${phase.id}', '${phase.status === 'completed' ? 'in_progress' : 'completed'}')">${phase.status === 'completed' ? '‚Ü©Ô∏è Reabrir' : '‚úÖ Concluir'}</button>
                            </div>`;
                        }

                        pHeader.innerHTML = `<div><h4>${phase.name}</h4><small>${phase.status}</small></div>${phaseActions}`;
                        pHeader.onclick = (e) => { if(e.target.tagName !== 'BUTTON') pHeader.classList.toggle('expanded'); };
                        contentDiv.appendChild(pHeader);

                        const pContent = document.createElement('div');
                        pContent.className = 'phase-content';
                        
                        phase.laborai_phase_updates.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(upd => {
                            const uDiv = document.createElement('div');
                            uDiv.className = 'update';
                            
                            let content = `<p style="margin-top:5px;">${upd.description || ''}</p>`;

                            // --- L√ìGICA DE IMAGEM CORRIGIDA ---
                            if (upd.update_type === 'image' && upd.content_url) {
                                const directImageUrl = getGoogleDriveDirectImage(upd.content_url);
                                if (directImageUrl && directImageUrl.length > 30) { 
                                    const safeUpd = JSON.stringify(upd).replace(/'/g, "&apos;");
                                    content += `<img src="${directImageUrl}" 
                                                     onclick='openImageLightbox(${safeUpd})' 
                                                     onerror="this.style.display='none'" 
                                                     style="margin-top:10px; display: block; border-radius: 4px; max-width: 100%;">`;
                                }
                            }

                            if (upd.link_url) content += `<a href="${upd.link_url}" target="_blank" style="color:var(--primary-accent); display:block; margin-top:10px;">üîó Link</a>`;

                            let updActions = '';
                            if (isAdminMode) {
                                const safeUpd = JSON.stringify(upd).replace(/'/g, "&apos;");
                                updActions = `<div class="update-actions">
                                                <button class="icon-btn secondary" onclick='handleEditUpdate(${safeUpd})'>‚úèÔ∏è</button>
                                                <button class="icon-btn" style="background:#25D366" onclick="notifyWhatsApp('${upd.id}', '${project.id}')">üì±</button>
                                                <button class="icon-btn danger" onclick="deleteUpdate('${upd.id}')">üóëÔ∏è</button>
                                              </div>`;
                            }

                            uDiv.innerHTML = `${updActions}<strong>${upd.title}</strong><small style="display:block; color:var(--text-secondary);">${new Date(upd.created_at).toLocaleString()}</small>${content}`;
                            pContent.appendChild(uDiv);
                        });
                        contentDiv.appendChild(pContent);
                    });
                }
            }

            // --- NAVEGA√á√ÉO E EVENTOS ---
            window.openClientProjects = (id) => { state.currentClientId = id; renderHeader(); renderProjectList(id); showView('projectList'); };
            window.openProjectDetail = (id) => { renderProjectDetail(id); showView('projectDetail'); };
            
            document.getElementById('client-view-toggle').onchange = (e) => { state.isSimulatingClient = e.target.checked; renderHeader(); location.reload(); };

            document.getElementById('toggle-add-update-form').onclick = () => {
                showGenericModal({
                    title: 'Nova Atualiza√ß√£o',
                    bodyHtml: document.getElementById('add-update-form-container').innerHTML,
                    buttons: []
                });
                const mForm = document.querySelector('#generic-modal #add-update-form');
                mForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const fd = new FormData();
                    fd.append('phaseId', mForm.querySelector('#update-phase-select').value);
                    fd.append('title', mForm.querySelector('#update-title').value);
                    fd.append('description', mForm.querySelector('#update-description').value);
                    fd.append('link', mForm.querySelector('#update-link').value);
                    fd.append('file', mForm.querySelector('#update-file').files[0]);
                    await handleSaveUpdate(fd);
                    Toast.success('Salvo!');
                    await loadData(); renderProjectDetail(state.currentProjectId);
                    document.getElementById('generic-modal').classList.add('hidden');
                };
            };

            async function handleSaveUpdate(fd, id = null) {
                let url = `${HOOKS.SALVAR_ATUALIZACAO}?title=${encodeURIComponent(fd.get('title'))}&description=${encodeURIComponent(fd.get('description'))}&contentUrl=${encodeURIComponent(fd.get('link'))}`;
                if (id) url += `&updateId=${id}`; else url += `&phaseId=${fd.get('phaseId')}`;
                const file = fd.get('file');
                let opt = { method: 'POST' };
                if (file && file.size > 0) { url += `&fileName=${encodeURIComponent(file.name)}`; opt.body = file; }
                await fetch(url, opt);
            }

            window.notifyWhatsApp = async (uId, pId) => {
                showGenericModal({
                    title: 'Notificar WhatsApp',
                    bodyHtml: '<p>Enviar para os contatos?</p>',
                    buttons: [{ label: 'Enviar', classes: 'primary', onClick: async () => { await fetch(HOOKS.NOTIFICAR_WHATSAPP, { method: 'POST', body: JSON.stringify({ updateId: uId, projectId: pId }) }); Toast.success('Enviado!'); } }]
                });
            };

            window.openContactsModal = async (clientId, clientName) => {
                state.currentManageClientId = clientId;
                document.getElementById('contacts-modal-client-name').innerText = clientName;
                const container = document.getElementById('contacts-list-container');
                container.innerHTML = 'Carregando...';
                document.getElementById('contacts-modal').classList.remove('hidden');
                const { data } = await supabaseClient.from('laborai_client_contacts').select('*').eq('client_id', clientId);
                container.innerHTML = '';
                if(data) data.forEach(c => {
                    const d = document.createElement('div'); d.className = 'contact-item';
                    d.innerHTML = `<div><strong>${c.name}</strong><br><small>${c.whatsapp}</small></div><button class="danger icon-btn" onclick="deleteContact('${c.id}')">üóëÔ∏è</button>`;
                    container.appendChild(d);
                });
            };

            document.getElementById('add-contact-form').onsubmit = async (e) => {
                e.preventDefault();
                await fetch(HOOKS.CRIAR_CONTATO, { method: 'POST', body: JSON.stringify({ clientId: state.currentManageClientId, name: document.getElementById('contact-name').value, role: document.getElementById('contact-role').value, whatsapp: document.getElementById('contact-whatsapp').value }), headers: {'Content-Type':'application/json'} });
                Toast.success('Adicionado');
                openContactsModal(state.currentManageClientId, "");
            };

            window.deleteContact = async (id) => {
                await fetch(HOOKS.EXCLUIR_CONTATO, { method: 'POST', body: JSON.stringify({ contactId: id }), headers: {'Content-Type':'application/json'} });
                openContactsModal(state.currentManageClientId, "");
            };

            window.handleEditProject = (p) => {
                showGenericModal({
                    title: 'Editar Projeto',
                    bodyHtml: `<input id="en" value="${p.name}"><textarea id="ed">${p.description || ''}</textarea>`,
                    buttons: [{ label: 'Salvar', classes: 'primary', onClick: async () => {
                        await fetch(HOOKS.EDITAR_PROJETO, { method: 'POST', body: JSON.stringify({ projectId: p.id, updates: [{field:'name', value:document.getElementById('en').value}, {field:'description', value:document.getElementById('ed').value}] }), headers: {'Content-Type':'application/json'} });
                        await loadData(); renderProjectList(state.currentClientId);
                    }}]
                });
            };

            window.handleDeleteProject = (id) => {
                showGenericModal({ title: 'Excluir?', bodyHtml: '<p>Apagar tudo?</p>', buttons: [{ label: 'Excluir', classes: 'danger', onClick: async () => { await fetch(HOOKS.EXCLUIR_PROJETO, { method: 'POST', body: JSON.stringify({ projectId: id }), headers: {'Content-Type':'application/json'} }); await loadData(); renderProjectList(state.currentClientId); } }] });
            };

            window.handleEditUpdate = (u) => {
                showGenericModal({
                    title: 'Editar Atualiza√ß√£o',
                    bodyHtml: `<input id="ut" value="${u.title}"><textarea id="ud">${u.description || ''}</textarea><input id="ul" value="${u.link_url || ''}"><input type="file" id="uf">`,
                    buttons: [{ label: 'Salvar', classes: 'primary', onClick: async () => {
                        const fd = new FormData();
                        fd.append('title', document.getElementById('ut').value);
                        fd.append('description', document.getElementById('ud').value);
                        fd.append('link', document.getElementById('ul').value);
                        fd.append('file', document.getElementById('uf').files[0]);
                        await handleSaveUpdate(fd, u.id);
                        await loadData(); renderProjectDetail(state.currentProjectId);
                    }}]
                });
            };

            window.deleteUpdate = (id) => {
                showGenericModal({ title: 'Apagar?', bodyHtml: '<p>Remover da timeline?</p>', buttons: [{ label: 'Sim', classes: 'danger', onClick: async () => { await fetch(HOOKS.EXCLUIR_ATUALIZACAO, { method: 'POST', body: JSON.stringify({ updateId: id }), headers: {'Content-Type':'application/json'} }); await loadData(); renderProjectDetail(state.currentProjectId); } }] });
            };

            window.changePhaseStatus = async (id, s) => {
                await fetch(HOOKS.ATUALIZAR_STATUS_FASE, { method: 'POST', body: JSON.stringify({ phaseId: id, newStatus: s }), headers: {'Content-Type':'application/json'} });
                await loadData(); renderProjectDetail(state.currentProjectId);
            };

            document.getElementById('save-progress-button').onclick = async () => {
                const v = document.getElementById('progress-slider').value;
                await fetch(HOOKS.ATUALIZAR_PROGRESSO, { method: 'POST', body: JSON.stringify({ versionId: state.currentVersionId, newProgress: parseInt(v) }), headers: {'Content-Type':'application/json'} });
                Toast.success('Salvo'); await loadData(); renderProjectDetail(state.currentProjectId);
            };

            document.getElementById('login-form').onsubmit = async (e) => {
                e.preventDefault();
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value });
                if (error) Toast.error(error.message); else initApp(data.user);
            };

            document.getElementById('logout-button').onclick = () => { supabaseClient.auth.signOut().then(() => location.reload()); };
            document.getElementById('admin-panel-button').onclick = () => { populateDropdowns(); showView('adminForms'); };
            document.getElementById('back-from-admin-panel').onclick = () => { renderProjectList(state.currentClientId); showView('projectList'); };
            document.getElementById('back-to-clients-button').onclick = () => { state.currentClientId = null; renderHeader(); showView('clientList'); };
            document.getElementById('back-to-projects-button').onclick = () => { renderProjectList(state.currentClientId); showView('projectList'); };

            function populateDropdowns() {
                const clients = state.clients;
                const selects = [document.getElementById('logo-client-select'), document.getElementById('project-client-select'), document.getElementById('user-client-select')];
                selects.forEach(s => {
                    s.innerHTML = '<option value="">Selecione...</option>';
                    clients.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.innerText = c.name; s.appendChild(o); });
                });
                const ts = document.getElementById('phase-template-select');
                ts.innerHTML = '';
                state.phaseTemplates.forEach(t => { const o = document.createElement('option'); o.value = t.name; o.innerText = t.name; ts.appendChild(o); });
            }

            // Lightbox
            window.openImageLightbox = (u) => {
                const lb = document.getElementById('image-lightbox');
                const img = document.getElementById('lightbox-img');
                const url = getGoogleDriveDirectImage(u.content_url);
                if(!url) return;
                img.src = url;
                document.getElementById('lightbox-update-title').innerText = u.title;
                document.getElementById('lightbox-update-description').innerText = u.description || '';
                document.getElementById('lightbox-download-link').href = u.content_url;
                lb.classList.remove('hidden');
            };
            document.getElementById('image-lightbox').onclick = (e) => { if(e.target.id === 'image-lightbox') e.target.classList.add('hidden'); };

            async function initApp(user) {
                state.user = user;
                state.isAdmin = user.user_metadata.role === 'admin';
                await loadData(); renderHeader(); showView('app');
                if (state.isAdmin) { renderClientList(); showView('clientList'); }
                else { renderProjectList(user.user_metadata.clientId); showView('projectList'); }
            }

            supabaseClient.auth.getSession().then(({ data: { session } }) => { if (session) initApp(session.user); else showView('login'); });
        });
    </script>
</body>
</html>
